# Vulnerability: java/xss
## Message: Cross-site scripting vulnerability due to a [user-provided value](1).
Cross-site scripting vulnerability due to a [user-provided value](2).
Cross-site scripting vulnerability due to a [user-provided value](3).

## Code Flow 1

### Thread Flow 1

### Data Flow Step 1: adapters/oidc/spring-security/src/main/java/org/keycloak/adapters/springsecurity/facade/WrappedHttpServletRequest.java, Line 59, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/oidc/spring-security/src/main/java/org/keycloak/adapters/springsecurity/facade/WrappedHttpServletRequest.java
```java
>>>   59:         return request.getParameter(param);
```

### Data Flow Step 2: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java, Line 40, Column 29
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java
```java
>>>   40:         String relayState = facade.getRequest().getFirstParam(GeneralConstants.RELAY_STATE);
```

**Intermediate code within method `handle` (lines 41-41):**
```java
      41:         if (samlRequest != null) {
      42:             return handleSamlRequest(samlRequest, relayState);
```

### Data Flow Step 3: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java, Line 42, Column 51
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java
```java
>>>   42:             return handleSamlRequest(samlRequest, relayState);
```

### Data Flow Step 4: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 163, Column 65
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
>>>  163:     protected AuthOutcome handleSamlRequest(String samlRequest, String relayState) {
```

**Intermediate code within method `handleSamlRequest` (lines 164-201):**
```java
     164:         SAMLDocumentHolder holder = null;
     165:         boolean postBinding = false;
     166:         String requestUri = facade.getRequest().getURI();
     167:         if (facade.getRequest().getMethod().equalsIgnoreCase("GET")) {
     168:             // strip out query params
     169:             int index = requestUri.indexOf('?');
     170:             if (index > -1) {
     171:                 requestUri = requestUri.substring(0, index);
     172:             }
     173:             holder = SAMLRequestParser.parseRequestRedirectBinding(samlRequest);
     174:         } else {
     175:             postBinding = true;
     176:             holder = SAMLRequestParser.parseRequestPostBinding(samlRequest);
     177:         }
     178:         if (holder == null) {
     179:             log.error("Error parsing SAML document");
     180:             return failedTerminal();
     181:         }
     182:         RequestAbstractType requestAbstractType = (RequestAbstractType) holder.getSamlObject();
     183:         if (requestAbstractType.getDestination() == null && containsUnencryptedSignature(holder, postBinding)) {
     184:             log.error("Destination field required.");
     185:             return failed(CHALLENGE_EXTRACTION_FAILURE);
     186:         }
     187:         if (! destinationValidator.validate(requestUri, requestAbstractType.getDestination())) {
     188:             log.error("Expected destination '" + requestUri + "' got '" + requestAbstractType.getDestination() + "'");
     189:             return failedTerminal();
     190:         }
     191: 
     192:         if (requestAbstractType instanceof LogoutRequestType) {
     193:             if (deployment.getIDP().getSingleLogoutService().validateRequestSignature()) {
     194:                 try {
     195:                     validateSamlSignature(holder, postBinding, GeneralConstants.SAML_REQUEST_KEY);
     196:                 } catch (VerificationException e) {
     197:                     log.error("Failed to verify saml request signature", e);
     198:                     return failedTerminal();
     199:                 }
     200:             }
     201:             LogoutRequestType logout = (LogoutRequestType) requestAbstractType;
     202:             return logoutRequest(logout, relayState);
```

### Data Flow Step 5: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 202, Column 42
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
>>>  202:             return logoutRequest(logout, relayState);
```

### Data Flow Step 6: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 68, Column 68
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
>>>   68:     protected AuthOutcome logoutRequest(LogoutRequestType request, String relayState) {
```

**Intermediate code within method `logoutRequest` (lines 69-79):**
```java
      69:         if (request.getSessionIndex() == null || request.getSessionIndex().isEmpty()) {
      70:             sessionStore.logoutByPrincipal(request.getNameID().getValue());
      71:         } else {
      72:             sessionStore.logoutBySsoId(request.getSessionIndex());
      73:         }
      74: 
      75:         String issuerURL = deployment.getEntityID();
      76:         SAML2LogoutResponseBuilder builder = new SAML2LogoutResponseBuilder();
      77:         builder.logoutRequestID(request.getID());
      78:         builder.destination(deployment.getIDP().getSingleLogoutService().getResponseBindingUrl());
      79:         builder.issuer(issuerURL);
      80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
```

### Data Flow Step 7: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 80, Column 84
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
>>>   80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
```

### Data Flow Step 8: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 139, Column 25
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  139:     public T relayState(String relayState) {
```

### Data Flow Step 9: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 140, Column 27
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  140:         this.relayState = relayState;
```

### Data Flow Step 10: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 140, Column 9
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  140:         this.relayState = relayState;
```

### Data Flow Step 11: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 141, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  141:         return (T)this;
```

### Data Flow Step 12: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 80, Column 43
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
>>>   80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
```

**Intermediate code within method `logoutRequest` (lines 81-92):**
```java
      81:         if (deployment.getIDP().getSingleLogoutService().signResponse()) {
      82:             if (deployment.getSignatureCanonicalizationMethod() != null)
      83:                 binding.canonicalizationMethod(deployment.getSignatureCanonicalizationMethod());
      84:             binding.signatureAlgorithm(deployment.getSignatureAlgorithm())
      85:                     .signWith(null, deployment.getSigningKeyPair())
      86:                     .signDocument();
      87:             // TODO: As part of KEYCLOAK-3810, add KeyID to the SAML document
      88:             //   <related DocumentBuilder>.addExtension(new KeycloakKeySamlExtensionGenerator(<key ID>));
      89:         }
      90: 
      91: 
      92:         try {
      93:             SamlUtil.sendSaml(false, facade, deployment.getIDP().getSingleLogoutService().getResponseBindingUrl(), binding, builder.buildDocument(),
```

### Data Flow Step 13: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 93, Column 116
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
>>>   93:             SamlUtil.sendSaml(false, facade, deployment.getIDP().getSingleLogoutService().getResponseBindingUrl(), binding, builder.buildDocument(),
```

### Data Flow Step 14: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 42, Column 29
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   42:                             BaseSAML2BindingBuilder binding, Document document,
```

**Intermediate code within method `sendSaml` (lines 43-44):**
```java
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
      45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
```

### Data Flow Step 15: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
```

### Data Flow Step 16: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 242, Column 35
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  242:     public BasePostBindingBuilder postBinding(Document document) throws ProcessingException {
```

### Data Flow Step 17: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 243, Column 43
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  243:         return new BasePostBindingBuilder(this, document);
```

### Data Flow Step 18: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 148, Column 39
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
```

### Data Flow Step 19: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 149, Column 28
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  149:             this.builder = builder;
```

### Data Flow Step 20: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 149, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  149:             this.builder = builder;
```

### Data Flow Step 21: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 148, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
```

### Data Flow Step 22: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 243, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  243:         return new BasePostBindingBuilder(this, document);
```

### Data Flow Step 23: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
```

### Data Flow Step 24: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 167, Column 23
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
```

### Data Flow Step 25: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
```

### Data Flow Step 26: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
```

### Data Flow Step 27: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 330, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  330:     public String buildHtmlPostResponse(Document responseDoc, String actionUrl, boolean asRequest) throws ProcessingException, ConfigurationException, IOException {
```

### Data Flow Step 28: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 331, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
```

### Data Flow Step 29: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 339, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  339:     public String buildHtml(String samlResponse, String actionUrl, boolean asRequest) {
```

**Intermediate code within method `buildHtml` (lines 340-349):**
```java
     340: 
     341:         String key = GeneralConstants.SAML_RESPONSE_KEY;
     342: 
     343:         if (asRequest) {
     344:             key = GeneralConstants.SAML_REQUEST_KEY;
     345:         }
     346: 
     347:         Map<String, String> inputTypes = new HashMap<>();
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
     350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
```

### Data Flow Step 30: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 58
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
```

### Data Flow Step 31: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 58
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
```

### Data Flow Step 32: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
```

**Intermediate code within method `buildHtml` (lines 351-352):**
```java
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
```

### Data Flow Step 33: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 353, Column 41
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  353:         return buildHtmlForm(actionUrl, inputTypes);
```

### Data Flow Step 34: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 356, Column 51
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  356:     public String buildHtmlForm(String actionUrl, Map<String, String> inputTypes) {
```

**Intermediate code within method `buildHtmlForm` (lines 357-370):**
```java
     357:         StringBuilder builder = new StringBuilder();
     358: 
     359:         builder.append("<HTML>")
     360:                 .append("<HEAD>")
     361: 
     362:                 .append("<TITLE>Authentication Redirect</TITLE>")
     363:                 .append("</HEAD>")
     364:                 .append("<BODY Onload=\"document.forms[0].submit()\">")
     365: 
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
     371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

### Data Flow Step 35: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 130
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

### Data Flow Step 36: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 130
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

### Data Flow Step 37: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 30, Column 42
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   30:     public static String escapeAttribute(String value) {
```

**Intermediate code within method `escapeAttribute` (lines 31-33):**
```java
      31:         StringBuilder escaped = new StringBuilder();
      32: 
      33:         for (int i = 0; i < value.length(); i++) {
      34:             char chr = value.charAt(i);
```

### Data Flow Step 38: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 34, Column 24
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   34:             char chr = value.charAt(i);
```

### Data Flow Step 39: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 34, Column 24
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   34:             char chr = value.charAt(i);
```

**Intermediate code within method `escapeAttribute` (lines 35-46):**
```java
      35: 
      36:             if (chr == '<') {
      37:                 escaped.append("&lt;");
      38:             } else if (chr == '>') {
      39:                 escaped.append("&gt;");
      40:             } else if (chr == '"') {
      41:                 escaped.append("&quot;");
      42:             } else if (chr == '\'') {
      43:                 escaped.append("&apos;");
      44:             } else if (chr == '&') {
      45:                 escaped.append("&amp;");
      46:             } else {
      47:                 escaped.append(chr);
```

### Data Flow Step 40: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 47, Column 32
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   47:                 escaped.append(chr);
```

### Data Flow Step 41: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 47, Column 17
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   47:                 escaped.append(chr);
```

**Intermediate code within method `escapeAttribute` (lines 48-50):**
```java
      48:             }
      49:         }
      50: 
      51:         return escaped.toString();
```

### Data Flow Step 42: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 51, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   51:         return escaped.toString();
```

### Data Flow Step 43: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 51, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   51:         return escaped.toString();
```

### Data Flow Step 44: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 114
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

### Data Flow Step 45: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

**Intermediate code within method `buildHtmlForm` (lines 372-380):**
```java
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
     377:                 .append("</NOSCRIPT>")
     378: 
     379:                 .append("</FORM></BODY></HTML>");
     380: 
     381:         return builder.toString();
```

### Data Flow Step 46: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 381, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  381:         return builder.toString();
```

### Data Flow Step 47: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 381, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  381:         return builder.toString();
```

### Data Flow Step 48: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 353, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  353:         return buildHtmlForm(actionUrl, inputTypes);
```

### Data Flow Step 49: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 331, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
```

### Data Flow Step 50: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
```

### Data Flow Step 51: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 169, Column 20
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  169:             return str;
```

### Data Flow Step 52: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
```

**Intermediate code within method `sendSaml` (lines 46-49):**
```java
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
      50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 53: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 50, Column 62
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 54: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 50, Column 62
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

## Code Flow 2

### Thread Flow 1

### Data Flow Step 1: adapters/oidc/spring-security/src/main/java/org/keycloak/adapters/springsecurity/facade/WrappedHttpServletRequest.java, Line 59, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/oidc/spring-security/src/main/java/org/keycloak/adapters/springsecurity/facade/WrappedHttpServletRequest.java
```java
>>>   59:         return request.getParameter(param);
```

### Data Flow Step 2: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 53, Column 17
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
>>>   53:                 facade.getRequest().getFirstParam(GeneralConstants.RELAY_STATE)), onCreateSession);
```

### Data Flow Step 3: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java, Line 33, Column 75
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java
```java
>>>   33:     public SamlInvocationContext(String samlRequest, String samlResponse, String relayState) {
```

### Data Flow Step 4: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java, Line 36, Column 27
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java
```java
>>>   36:         this.relayState = relayState;
```

### Data Flow Step 5: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java, Line 36, Column 9
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java
```java
>>>   36:         this.relayState = relayState;
```

### Data Flow Step 6: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java, Line 33, Column 12
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java
```java
>>>   33:     public SamlInvocationContext(String samlRequest, String samlResponse, String relayState) {
```

### Data Flow Step 7: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 51, Column 25
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
>>>   51:         return doHandle(new SamlInvocationContext(facade.getRequest().getFirstParam(GeneralConstants.SAML_REQUEST_KEY),
```

### Data Flow Step 8: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 138, Column 33
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
>>>  138:     public AuthOutcome doHandle(SamlInvocationContext context, OnSessionCreated onCreateSession) {
```

**Intermediate code within method `doHandle` (lines 139-140):**
```java
     139:         String samlRequest = context.getSamlRequest();
     140:         String samlResponse = context.getSamlResponse();
     141:         String relayState = context.getRelayState();
```

### Data Flow Step 9: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 141, Column 29
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
>>>  141:         String relayState = context.getRelayState();
```

### Data Flow Step 10: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java, Line 47, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java
```java
>>>   47:     public String getRelayState() {
```

### Data Flow Step 11: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java, Line 48, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java
```java
>>>   48:         return this.relayState;
```

### Data Flow Step 12: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java, Line 48, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java
```java
>>>   48:         return this.relayState;
```

### Data Flow Step 13: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 141, Column 29
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
>>>  141:         String relayState = context.getRelayState();
```

**Intermediate code within method `doHandle` (lines 142-142):**
```java
     142:         if (samlRequest != null) {
     143:             return handleSamlRequest(samlRequest, relayState);
```

### Data Flow Step 14: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 143, Column 51
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
>>>  143:             return handleSamlRequest(samlRequest, relayState);
```

### Data Flow Step 15: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 163, Column 65
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
>>>  163:     protected AuthOutcome handleSamlRequest(String samlRequest, String relayState) {
```

**Intermediate code within method `handleSamlRequest` (lines 164-201):**
```java
     164:         SAMLDocumentHolder holder = null;
     165:         boolean postBinding = false;
     166:         String requestUri = facade.getRequest().getURI();
     167:         if (facade.getRequest().getMethod().equalsIgnoreCase("GET")) {
     168:             // strip out query params
     169:             int index = requestUri.indexOf('?');
     170:             if (index > -1) {
     171:                 requestUri = requestUri.substring(0, index);
     172:             }
     173:             holder = SAMLRequestParser.parseRequestRedirectBinding(samlRequest);
     174:         } else {
     175:             postBinding = true;
     176:             holder = SAMLRequestParser.parseRequestPostBinding(samlRequest);
     177:         }
     178:         if (holder == null) {
     179:             log.error("Error parsing SAML document");
     180:             return failedTerminal();
     181:         }
     182:         RequestAbstractType requestAbstractType = (RequestAbstractType) holder.getSamlObject();
     183:         if (requestAbstractType.getDestination() == null && containsUnencryptedSignature(holder, postBinding)) {
     184:             log.error("Destination field required.");
     185:             return failed(CHALLENGE_EXTRACTION_FAILURE);
     186:         }
     187:         if (! destinationValidator.validate(requestUri, requestAbstractType.getDestination())) {
     188:             log.error("Expected destination '" + requestUri + "' got '" + requestAbstractType.getDestination() + "'");
     189:             return failedTerminal();
     190:         }
     191: 
     192:         if (requestAbstractType instanceof LogoutRequestType) {
     193:             if (deployment.getIDP().getSingleLogoutService().validateRequestSignature()) {
     194:                 try {
     195:                     validateSamlSignature(holder, postBinding, GeneralConstants.SAML_REQUEST_KEY);
     196:                 } catch (VerificationException e) {
     197:                     log.error("Failed to verify saml request signature", e);
     198:                     return failedTerminal();
     199:                 }
     200:             }
     201:             LogoutRequestType logout = (LogoutRequestType) requestAbstractType;
     202:             return logoutRequest(logout, relayState);
```

### Data Flow Step 16: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 202, Column 42
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
>>>  202:             return logoutRequest(logout, relayState);
```

### Data Flow Step 17: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 68, Column 68
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
>>>   68:     protected AuthOutcome logoutRequest(LogoutRequestType request, String relayState) {
```

**Intermediate code within method `logoutRequest` (lines 69-79):**
```java
      69:         if (request.getSessionIndex() == null || request.getSessionIndex().isEmpty()) {
      70:             sessionStore.logoutByPrincipal(request.getNameID().getValue());
      71:         } else {
      72:             sessionStore.logoutBySsoId(request.getSessionIndex());
      73:         }
      74: 
      75:         String issuerURL = deployment.getEntityID();
      76:         SAML2LogoutResponseBuilder builder = new SAML2LogoutResponseBuilder();
      77:         builder.logoutRequestID(request.getID());
      78:         builder.destination(deployment.getIDP().getSingleLogoutService().getResponseBindingUrl());
      79:         builder.issuer(issuerURL);
      80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
```

### Data Flow Step 18: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 80, Column 84
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
>>>   80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
```

### Data Flow Step 19: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 139, Column 25
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  139:     public T relayState(String relayState) {
```

### Data Flow Step 20: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 140, Column 27
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  140:         this.relayState = relayState;
```

### Data Flow Step 21: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 140, Column 9
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  140:         this.relayState = relayState;
```

### Data Flow Step 22: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 141, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  141:         return (T)this;
```

### Data Flow Step 23: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 80, Column 43
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
>>>   80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
```

**Intermediate code within method `logoutRequest` (lines 81-92):**
```java
      81:         if (deployment.getIDP().getSingleLogoutService().signResponse()) {
      82:             if (deployment.getSignatureCanonicalizationMethod() != null)
      83:                 binding.canonicalizationMethod(deployment.getSignatureCanonicalizationMethod());
      84:             binding.signatureAlgorithm(deployment.getSignatureAlgorithm())
      85:                     .signWith(null, deployment.getSigningKeyPair())
      86:                     .signDocument();
      87:             // TODO: As part of KEYCLOAK-3810, add KeyID to the SAML document
      88:             //   <related DocumentBuilder>.addExtension(new KeycloakKeySamlExtensionGenerator(<key ID>));
      89:         }
      90: 
      91: 
      92:         try {
      93:             SamlUtil.sendSaml(false, facade, deployment.getIDP().getSingleLogoutService().getResponseBindingUrl(), binding, builder.buildDocument(),
```

### Data Flow Step 24: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 93, Column 116
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
>>>   93:             SamlUtil.sendSaml(false, facade, deployment.getIDP().getSingleLogoutService().getResponseBindingUrl(), binding, builder.buildDocument(),
```

### Data Flow Step 25: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 42, Column 29
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   42:                             BaseSAML2BindingBuilder binding, Document document,
```

**Intermediate code within method `sendSaml` (lines 43-44):**
```java
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
      45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
```

### Data Flow Step 26: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
```

### Data Flow Step 27: services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java, Line 121, Column 31
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java
```java
>>>  121:     public PostBindingBuilder postBinding(Document document) throws ProcessingException  {
```

### Data Flow Step 28: services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java, Line 122, Column 39
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java
```java
>>>  122:         return new PostBindingBuilder(this, document);
```

### Data Flow Step 29: services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java, Line 49, Column 35
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java
```java
>>>   49:         public PostBindingBuilder(JaxrsSAML2BindingBuilder builder, Document document) throws ProcessingException {
```

### Data Flow Step 30: services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java, Line 50, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java
```java
>>>   50:             super(builder, document);
```

### Data Flow Step 31: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 148, Column 39
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
```

### Data Flow Step 32: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 149, Column 28
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  149:             this.builder = builder;
```

### Data Flow Step 33: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 149, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  149:             this.builder = builder;
```

### Data Flow Step 34: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 148, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
```

### Data Flow Step 35: services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java, Line 50, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java
```java
>>>   50:             super(builder, document);
```

### Data Flow Step 36: services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java, Line 49, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java
```java
>>>   49:         public PostBindingBuilder(JaxrsSAML2BindingBuilder builder, Document document) throws ProcessingException {
```

### Data Flow Step 37: services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java, Line 122, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java
```java
>>>  122:         return new PostBindingBuilder(this, document);
```

### Data Flow Step 38: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
```

### Data Flow Step 39: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 167, Column 23
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
```

### Data Flow Step 40: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
```

### Data Flow Step 41: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
```

### Data Flow Step 42: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 330, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  330:     public String buildHtmlPostResponse(Document responseDoc, String actionUrl, boolean asRequest) throws ProcessingException, ConfigurationException, IOException {
```

### Data Flow Step 43: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 331, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
```

### Data Flow Step 44: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 339, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  339:     public String buildHtml(String samlResponse, String actionUrl, boolean asRequest) {
```

**Intermediate code within method `buildHtml` (lines 340-348):**
```java
     340: 
     341:         String key = GeneralConstants.SAML_RESPONSE_KEY;
     342: 
     343:         if (asRequest) {
     344:             key = GeneralConstants.SAML_REQUEST_KEY;
     345:         }
     346: 
     347:         Map<String, String> inputTypes = new HashMap<>();
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
```

### Data Flow Step 45: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 349, Column 23
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  349:         if (isNotNull(relayState)) {
```

### Data Flow Step 46: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 349, Column 23
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  349:         if (isNotNull(relayState)) {
```

### Data Flow Step 47: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 58
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
```

### Data Flow Step 48: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
```

**Intermediate code within method `buildHtml` (lines 351-352):**
```java
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
```

### Data Flow Step 49: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 353, Column 41
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  353:         return buildHtmlForm(actionUrl, inputTypes);
```

### Data Flow Step 50: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 356, Column 51
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  356:     public String buildHtmlForm(String actionUrl, Map<String, String> inputTypes) {
```

**Intermediate code within method `buildHtmlForm` (lines 357-370):**
```java
     357:         StringBuilder builder = new StringBuilder();
     358: 
     359:         builder.append("<HTML>")
     360:                 .append("<HEAD>")
     361: 
     362:                 .append("<TITLE>Authentication Redirect</TITLE>")
     363:                 .append("</HEAD>")
     364:                 .append("<BODY Onload=\"document.forms[0].submit()\">")
     365: 
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
     371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

### Data Flow Step 51: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 130
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

### Data Flow Step 52: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 130
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

### Data Flow Step 53: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 30, Column 42
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   30:     public static String escapeAttribute(String value) {
```

**Intermediate code within method `escapeAttribute` (lines 31-33):**
```java
      31:         StringBuilder escaped = new StringBuilder();
      32: 
      33:         for (int i = 0; i < value.length(); i++) {
      34:             char chr = value.charAt(i);
```

### Data Flow Step 54: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 34, Column 24
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   34:             char chr = value.charAt(i);
```

### Data Flow Step 55: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 34, Column 24
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   34:             char chr = value.charAt(i);
```

**Intermediate code within method `escapeAttribute` (lines 35-46):**
```java
      35: 
      36:             if (chr == '<') {
      37:                 escaped.append("&lt;");
      38:             } else if (chr == '>') {
      39:                 escaped.append("&gt;");
      40:             } else if (chr == '"') {
      41:                 escaped.append("&quot;");
      42:             } else if (chr == '\'') {
      43:                 escaped.append("&apos;");
      44:             } else if (chr == '&') {
      45:                 escaped.append("&amp;");
      46:             } else {
      47:                 escaped.append(chr);
```

### Data Flow Step 56: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 47, Column 32
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   47:                 escaped.append(chr);
```

### Data Flow Step 57: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 47, Column 17
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   47:                 escaped.append(chr);
```

**Intermediate code within method `escapeAttribute` (lines 48-50):**
```java
      48:             }
      49:         }
      50: 
      51:         return escaped.toString();
```

### Data Flow Step 58: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 51, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   51:         return escaped.toString();
```

### Data Flow Step 59: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 51, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   51:         return escaped.toString();
```

### Data Flow Step 60: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 114
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

### Data Flow Step 61: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

**Intermediate code within method `buildHtmlForm` (lines 372-380):**
```java
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
     377:                 .append("</NOSCRIPT>")
     378: 
     379:                 .append("</FORM></BODY></HTML>");
     380: 
     381:         return builder.toString();
```

### Data Flow Step 62: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 381, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  381:         return builder.toString();
```

### Data Flow Step 63: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 381, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  381:         return builder.toString();
```

### Data Flow Step 64: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 353, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  353:         return buildHtmlForm(actionUrl, inputTypes);
```

### Data Flow Step 65: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 331, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
```

### Data Flow Step 66: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
```

### Data Flow Step 67: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 169, Column 20
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  169:             return str;
```

### Data Flow Step 68: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
```

**Intermediate code within method `sendSaml` (lines 46-49):**
```java
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
      50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 69: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 50, Column 62
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 70: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 50, Column 62
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

## Code Flow 3

### Thread Flow 1

### Data Flow Step 1: adapters/spi/servlet-adapter-spi/src/main/java/org/keycloak/adapters/servlet/ServletHttpFacade.java, Line 93, Column 20
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/spi/servlet-adapter-spi/src/main/java/org/keycloak/adapters/servlet/ServletHttpFacade.java
```java
>>>   93:             return request.getParameter(param);
```

### Data Flow Step 2: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java, Line 40, Column 29
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java
```java
>>>   40:         String relayState = facade.getRequest().getFirstParam(GeneralConstants.RELAY_STATE);
```

**Intermediate code within method `handle` (lines 41-41):**
```java
      41:         if (samlRequest != null) {
      42:             return handleSamlRequest(samlRequest, relayState);
```

### Data Flow Step 3: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java, Line 42, Column 51
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java
```java
>>>   42:             return handleSamlRequest(samlRequest, relayState);
```

### Data Flow Step 4: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 163, Column 65
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
>>>  163:     protected AuthOutcome handleSamlRequest(String samlRequest, String relayState) {
```

**Intermediate code within method `handleSamlRequest` (lines 164-201):**
```java
     164:         SAMLDocumentHolder holder = null;
     165:         boolean postBinding = false;
     166:         String requestUri = facade.getRequest().getURI();
     167:         if (facade.getRequest().getMethod().equalsIgnoreCase("GET")) {
     168:             // strip out query params
     169:             int index = requestUri.indexOf('?');
     170:             if (index > -1) {
     171:                 requestUri = requestUri.substring(0, index);
     172:             }
     173:             holder = SAMLRequestParser.parseRequestRedirectBinding(samlRequest);
     174:         } else {
     175:             postBinding = true;
     176:             holder = SAMLRequestParser.parseRequestPostBinding(samlRequest);
     177:         }
     178:         if (holder == null) {
     179:             log.error("Error parsing SAML document");
     180:             return failedTerminal();
     181:         }
     182:         RequestAbstractType requestAbstractType = (RequestAbstractType) holder.getSamlObject();
     183:         if (requestAbstractType.getDestination() == null && containsUnencryptedSignature(holder, postBinding)) {
     184:             log.error("Destination field required.");
     185:             return failed(CHALLENGE_EXTRACTION_FAILURE);
     186:         }
     187:         if (! destinationValidator.validate(requestUri, requestAbstractType.getDestination())) {
     188:             log.error("Expected destination '" + requestUri + "' got '" + requestAbstractType.getDestination() + "'");
     189:             return failedTerminal();
     190:         }
     191: 
     192:         if (requestAbstractType instanceof LogoutRequestType) {
     193:             if (deployment.getIDP().getSingleLogoutService().validateRequestSignature()) {
     194:                 try {
     195:                     validateSamlSignature(holder, postBinding, GeneralConstants.SAML_REQUEST_KEY);
     196:                 } catch (VerificationException e) {
     197:                     log.error("Failed to verify saml request signature", e);
     198:                     return failedTerminal();
     199:                 }
     200:             }
     201:             LogoutRequestType logout = (LogoutRequestType) requestAbstractType;
     202:             return logoutRequest(logout, relayState);
```

### Data Flow Step 5: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 202, Column 42
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
>>>  202:             return logoutRequest(logout, relayState);
```

### Data Flow Step 6: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 68, Column 68
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
>>>   68:     protected AuthOutcome logoutRequest(LogoutRequestType request, String relayState) {
```

**Intermediate code within method `logoutRequest` (lines 69-79):**
```java
      69:         if (request.getSessionIndex() == null || request.getSessionIndex().isEmpty()) {
      70:             sessionStore.logoutByPrincipal(request.getNameID().getValue());
      71:         } else {
      72:             sessionStore.logoutBySsoId(request.getSessionIndex());
      73:         }
      74: 
      75:         String issuerURL = deployment.getEntityID();
      76:         SAML2LogoutResponseBuilder builder = new SAML2LogoutResponseBuilder();
      77:         builder.logoutRequestID(request.getID());
      78:         builder.destination(deployment.getIDP().getSingleLogoutService().getResponseBindingUrl());
      79:         builder.issuer(issuerURL);
      80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
```

### Data Flow Step 7: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 80, Column 84
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
>>>   80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
```

### Data Flow Step 8: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 139, Column 25
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  139:     public T relayState(String relayState) {
```

### Data Flow Step 9: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 140, Column 27
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  140:         this.relayState = relayState;
```

### Data Flow Step 10: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 140, Column 9
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  140:         this.relayState = relayState;
```

### Data Flow Step 11: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 141, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  141:         return (T)this;
```

### Data Flow Step 12: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 80, Column 43
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
>>>   80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
```

**Intermediate code within method `logoutRequest` (lines 81-92):**
```java
      81:         if (deployment.getIDP().getSingleLogoutService().signResponse()) {
      82:             if (deployment.getSignatureCanonicalizationMethod() != null)
      83:                 binding.canonicalizationMethod(deployment.getSignatureCanonicalizationMethod());
      84:             binding.signatureAlgorithm(deployment.getSignatureAlgorithm())
      85:                     .signWith(null, deployment.getSigningKeyPair())
      86:                     .signDocument();
      87:             // TODO: As part of KEYCLOAK-3810, add KeyID to the SAML document
      88:             //   <related DocumentBuilder>.addExtension(new KeycloakKeySamlExtensionGenerator(<key ID>));
      89:         }
      90: 
      91: 
      92:         try {
      93:             SamlUtil.sendSaml(false, facade, deployment.getIDP().getSingleLogoutService().getResponseBindingUrl(), binding, builder.buildDocument(),
```

### Data Flow Step 13: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 93, Column 116
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
>>>   93:             SamlUtil.sendSaml(false, facade, deployment.getIDP().getSingleLogoutService().getResponseBindingUrl(), binding, builder.buildDocument(),
```

### Data Flow Step 14: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 42, Column 29
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   42:                             BaseSAML2BindingBuilder binding, Document document,
```

**Intermediate code within method `sendSaml` (lines 43-44):**
```java
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
      45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
```

### Data Flow Step 15: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
```

### Data Flow Step 16: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 242, Column 35
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  242:     public BasePostBindingBuilder postBinding(Document document) throws ProcessingException {
```

### Data Flow Step 17: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 243, Column 43
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  243:         return new BasePostBindingBuilder(this, document);
```

### Data Flow Step 18: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 148, Column 39
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
```

### Data Flow Step 19: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 149, Column 28
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  149:             this.builder = builder;
```

### Data Flow Step 20: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 149, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  149:             this.builder = builder;
```

### Data Flow Step 21: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 148, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
```

### Data Flow Step 22: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 243, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  243:         return new BasePostBindingBuilder(this, document);
```

### Data Flow Step 23: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
```

### Data Flow Step 24: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 167, Column 23
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
```

### Data Flow Step 25: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
```

### Data Flow Step 26: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
```

### Data Flow Step 27: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 330, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  330:     public String buildHtmlPostResponse(Document responseDoc, String actionUrl, boolean asRequest) throws ProcessingException, ConfigurationException, IOException {
```

### Data Flow Step 28: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 331, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
```

### Data Flow Step 29: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 339, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  339:     public String buildHtml(String samlResponse, String actionUrl, boolean asRequest) {
```

**Intermediate code within method `buildHtml` (lines 340-349):**
```java
     340: 
     341:         String key = GeneralConstants.SAML_RESPONSE_KEY;
     342: 
     343:         if (asRequest) {
     344:             key = GeneralConstants.SAML_REQUEST_KEY;
     345:         }
     346: 
     347:         Map<String, String> inputTypes = new HashMap<>();
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
     350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
```

### Data Flow Step 30: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 58
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
```

### Data Flow Step 31: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 58
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
```

### Data Flow Step 32: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
```

**Intermediate code within method `buildHtml` (lines 351-352):**
```java
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
```

### Data Flow Step 33: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 353, Column 41
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  353:         return buildHtmlForm(actionUrl, inputTypes);
```

### Data Flow Step 34: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 356, Column 51
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  356:     public String buildHtmlForm(String actionUrl, Map<String, String> inputTypes) {
```

**Intermediate code within method `buildHtmlForm` (lines 357-370):**
```java
     357:         StringBuilder builder = new StringBuilder();
     358: 
     359:         builder.append("<HTML>")
     360:                 .append("<HEAD>")
     361: 
     362:                 .append("<TITLE>Authentication Redirect</TITLE>")
     363:                 .append("</HEAD>")
     364:                 .append("<BODY Onload=\"document.forms[0].submit()\">")
     365: 
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
     371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

### Data Flow Step 35: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 130
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

### Data Flow Step 36: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 130
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

### Data Flow Step 37: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 30, Column 42
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   30:     public static String escapeAttribute(String value) {
```

**Intermediate code within method `escapeAttribute` (lines 31-33):**
```java
      31:         StringBuilder escaped = new StringBuilder();
      32: 
      33:         for (int i = 0; i < value.length(); i++) {
      34:             char chr = value.charAt(i);
```

### Data Flow Step 38: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 34, Column 24
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   34:             char chr = value.charAt(i);
```

### Data Flow Step 39: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 34, Column 24
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   34:             char chr = value.charAt(i);
```

**Intermediate code within method `escapeAttribute` (lines 35-46):**
```java
      35: 
      36:             if (chr == '<') {
      37:                 escaped.append("&lt;");
      38:             } else if (chr == '>') {
      39:                 escaped.append("&gt;");
      40:             } else if (chr == '"') {
      41:                 escaped.append("&quot;");
      42:             } else if (chr == '\'') {
      43:                 escaped.append("&apos;");
      44:             } else if (chr == '&') {
      45:                 escaped.append("&amp;");
      46:             } else {
      47:                 escaped.append(chr);
```

### Data Flow Step 40: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 47, Column 32
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   47:                 escaped.append(chr);
```

### Data Flow Step 41: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 47, Column 17
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   47:                 escaped.append(chr);
```

**Intermediate code within method `escapeAttribute` (lines 48-50):**
```java
      48:             }
      49:         }
      50: 
      51:         return escaped.toString();
```

### Data Flow Step 42: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 51, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   51:         return escaped.toString();
```

### Data Flow Step 43: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 51, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   51:         return escaped.toString();
```

### Data Flow Step 44: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 114
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

### Data Flow Step 45: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

**Intermediate code within method `buildHtmlForm` (lines 372-380):**
```java
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
     377:                 .append("</NOSCRIPT>")
     378: 
     379:                 .append("</FORM></BODY></HTML>");
     380: 
     381:         return builder.toString();
```

### Data Flow Step 46: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 381, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  381:         return builder.toString();
```

### Data Flow Step 47: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 381, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  381:         return builder.toString();
```

### Data Flow Step 48: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 353, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  353:         return buildHtmlForm(actionUrl, inputTypes);
```

### Data Flow Step 49: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 331, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
```

### Data Flow Step 50: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
```

### Data Flow Step 51: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 169, Column 20
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  169:             return str;
```

### Data Flow Step 52: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
```

**Intermediate code within method `sendSaml` (lines 46-49):**
```java
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
      50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 53: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 50, Column 62
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 54: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 50, Column 62
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

## Code Flow 4

### Thread Flow 1

### Data Flow Step 1: adapters/spi/undertow-adapter-spi/src/main/java/org/keycloak/adapters/undertow/ServletHttpFacade.java, Line 46, Column 20
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/spi/undertow-adapter-spi/src/main/java/org/keycloak/adapters/undertow/ServletHttpFacade.java
```java
>>>   46:             return request.getParameter(param);
```

### Data Flow Step 2: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java, Line 40, Column 29
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java
```java
>>>   40:         String relayState = facade.getRequest().getFirstParam(GeneralConstants.RELAY_STATE);
```

**Intermediate code within method `handle` (lines 41-41):**
```java
      41:         if (samlRequest != null) {
      42:             return handleSamlRequest(samlRequest, relayState);
```

### Data Flow Step 3: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java, Line 42, Column 51
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java
```java
>>>   42:             return handleSamlRequest(samlRequest, relayState);
```

### Data Flow Step 4: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 163, Column 65
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
>>>  163:     protected AuthOutcome handleSamlRequest(String samlRequest, String relayState) {
```

**Intermediate code within method `handleSamlRequest` (lines 164-201):**
```java
     164:         SAMLDocumentHolder holder = null;
     165:         boolean postBinding = false;
     166:         String requestUri = facade.getRequest().getURI();
     167:         if (facade.getRequest().getMethod().equalsIgnoreCase("GET")) {
     168:             // strip out query params
     169:             int index = requestUri.indexOf('?');
     170:             if (index > -1) {
     171:                 requestUri = requestUri.substring(0, index);
     172:             }
     173:             holder = SAMLRequestParser.parseRequestRedirectBinding(samlRequest);
     174:         } else {
     175:             postBinding = true;
     176:             holder = SAMLRequestParser.parseRequestPostBinding(samlRequest);
     177:         }
     178:         if (holder == null) {
     179:             log.error("Error parsing SAML document");
     180:             return failedTerminal();
     181:         }
     182:         RequestAbstractType requestAbstractType = (RequestAbstractType) holder.getSamlObject();
     183:         if (requestAbstractType.getDestination() == null && containsUnencryptedSignature(holder, postBinding)) {
     184:             log.error("Destination field required.");
     185:             return failed(CHALLENGE_EXTRACTION_FAILURE);
     186:         }
     187:         if (! destinationValidator.validate(requestUri, requestAbstractType.getDestination())) {
     188:             log.error("Expected destination '" + requestUri + "' got '" + requestAbstractType.getDestination() + "'");
     189:             return failedTerminal();
     190:         }
     191: 
     192:         if (requestAbstractType instanceof LogoutRequestType) {
     193:             if (deployment.getIDP().getSingleLogoutService().validateRequestSignature()) {
     194:                 try {
     195:                     validateSamlSignature(holder, postBinding, GeneralConstants.SAML_REQUEST_KEY);
     196:                 } catch (VerificationException e) {
     197:                     log.error("Failed to verify saml request signature", e);
     198:                     return failedTerminal();
     199:                 }
     200:             }
     201:             LogoutRequestType logout = (LogoutRequestType) requestAbstractType;
     202:             return logoutRequest(logout, relayState);
```

### Data Flow Step 5: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 202, Column 42
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
>>>  202:             return logoutRequest(logout, relayState);
```

### Data Flow Step 6: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 68, Column 68
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
>>>   68:     protected AuthOutcome logoutRequest(LogoutRequestType request, String relayState) {
```

**Intermediate code within method `logoutRequest` (lines 69-79):**
```java
      69:         if (request.getSessionIndex() == null || request.getSessionIndex().isEmpty()) {
      70:             sessionStore.logoutByPrincipal(request.getNameID().getValue());
      71:         } else {
      72:             sessionStore.logoutBySsoId(request.getSessionIndex());
      73:         }
      74: 
      75:         String issuerURL = deployment.getEntityID();
      76:         SAML2LogoutResponseBuilder builder = new SAML2LogoutResponseBuilder();
      77:         builder.logoutRequestID(request.getID());
      78:         builder.destination(deployment.getIDP().getSingleLogoutService().getResponseBindingUrl());
      79:         builder.issuer(issuerURL);
      80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
```

### Data Flow Step 7: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 80, Column 84
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
>>>   80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
```

### Data Flow Step 8: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 139, Column 25
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  139:     public T relayState(String relayState) {
```

### Data Flow Step 9: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 140, Column 27
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  140:         this.relayState = relayState;
```

### Data Flow Step 10: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 140, Column 9
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  140:         this.relayState = relayState;
```

### Data Flow Step 11: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 141, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  141:         return (T)this;
```

### Data Flow Step 12: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 80, Column 43
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
>>>   80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
```

**Intermediate code within method `logoutRequest` (lines 81-92):**
```java
      81:         if (deployment.getIDP().getSingleLogoutService().signResponse()) {
      82:             if (deployment.getSignatureCanonicalizationMethod() != null)
      83:                 binding.canonicalizationMethod(deployment.getSignatureCanonicalizationMethod());
      84:             binding.signatureAlgorithm(deployment.getSignatureAlgorithm())
      85:                     .signWith(null, deployment.getSigningKeyPair())
      86:                     .signDocument();
      87:             // TODO: As part of KEYCLOAK-3810, add KeyID to the SAML document
      88:             //   <related DocumentBuilder>.addExtension(new KeycloakKeySamlExtensionGenerator(<key ID>));
      89:         }
      90: 
      91: 
      92:         try {
      93:             SamlUtil.sendSaml(false, facade, deployment.getIDP().getSingleLogoutService().getResponseBindingUrl(), binding, builder.buildDocument(),
```

### Data Flow Step 13: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 93, Column 116
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
>>>   93:             SamlUtil.sendSaml(false, facade, deployment.getIDP().getSingleLogoutService().getResponseBindingUrl(), binding, builder.buildDocument(),
```

### Data Flow Step 14: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 42, Column 29
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   42:                             BaseSAML2BindingBuilder binding, Document document,
```

**Intermediate code within method `sendSaml` (lines 43-44):**
```java
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
      45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
```

### Data Flow Step 15: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
```

### Data Flow Step 16: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 242, Column 35
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  242:     public BasePostBindingBuilder postBinding(Document document) throws ProcessingException {
```

### Data Flow Step 17: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 243, Column 43
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  243:         return new BasePostBindingBuilder(this, document);
```

### Data Flow Step 18: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 148, Column 39
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
```

### Data Flow Step 19: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 149, Column 28
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  149:             this.builder = builder;
```

### Data Flow Step 20: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 149, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  149:             this.builder = builder;
```

### Data Flow Step 21: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 148, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
```

### Data Flow Step 22: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 243, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  243:         return new BasePostBindingBuilder(this, document);
```

### Data Flow Step 23: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
```

### Data Flow Step 24: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 167, Column 23
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
```

### Data Flow Step 25: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
```

### Data Flow Step 26: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
```

### Data Flow Step 27: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 330, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  330:     public String buildHtmlPostResponse(Document responseDoc, String actionUrl, boolean asRequest) throws ProcessingException, ConfigurationException, IOException {
```

### Data Flow Step 28: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 331, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
```

### Data Flow Step 29: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 339, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  339:     public String buildHtml(String samlResponse, String actionUrl, boolean asRequest) {
```

**Intermediate code within method `buildHtml` (lines 340-349):**
```java
     340: 
     341:         String key = GeneralConstants.SAML_RESPONSE_KEY;
     342: 
     343:         if (asRequest) {
     344:             key = GeneralConstants.SAML_REQUEST_KEY;
     345:         }
     346: 
     347:         Map<String, String> inputTypes = new HashMap<>();
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
     350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
```

### Data Flow Step 30: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 58
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
```

### Data Flow Step 31: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 58
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
```

### Data Flow Step 32: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
```

**Intermediate code within method `buildHtml` (lines 351-352):**
```java
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
```

### Data Flow Step 33: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 353, Column 41
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  353:         return buildHtmlForm(actionUrl, inputTypes);
```

### Data Flow Step 34: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 356, Column 51
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  356:     public String buildHtmlForm(String actionUrl, Map<String, String> inputTypes) {
```

**Intermediate code within method `buildHtmlForm` (lines 357-370):**
```java
     357:         StringBuilder builder = new StringBuilder();
     358: 
     359:         builder.append("<HTML>")
     360:                 .append("<HEAD>")
     361: 
     362:                 .append("<TITLE>Authentication Redirect</TITLE>")
     363:                 .append("</HEAD>")
     364:                 .append("<BODY Onload=\"document.forms[0].submit()\">")
     365: 
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
     371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

### Data Flow Step 35: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 130
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

### Data Flow Step 36: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 130
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

### Data Flow Step 37: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 30, Column 42
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   30:     public static String escapeAttribute(String value) {
```

**Intermediate code within method `escapeAttribute` (lines 31-33):**
```java
      31:         StringBuilder escaped = new StringBuilder();
      32: 
      33:         for (int i = 0; i < value.length(); i++) {
      34:             char chr = value.charAt(i);
```

### Data Flow Step 38: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 34, Column 24
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   34:             char chr = value.charAt(i);
```

### Data Flow Step 39: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 34, Column 24
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   34:             char chr = value.charAt(i);
```

**Intermediate code within method `escapeAttribute` (lines 35-46):**
```java
      35: 
      36:             if (chr == '<') {
      37:                 escaped.append("&lt;");
      38:             } else if (chr == '>') {
      39:                 escaped.append("&gt;");
      40:             } else if (chr == '"') {
      41:                 escaped.append("&quot;");
      42:             } else if (chr == '\'') {
      43:                 escaped.append("&apos;");
      44:             } else if (chr == '&') {
      45:                 escaped.append("&amp;");
      46:             } else {
      47:                 escaped.append(chr);
```

### Data Flow Step 40: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 47, Column 32
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   47:                 escaped.append(chr);
```

### Data Flow Step 41: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 47, Column 17
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   47:                 escaped.append(chr);
```

**Intermediate code within method `escapeAttribute` (lines 48-50):**
```java
      48:             }
      49:         }
      50: 
      51:         return escaped.toString();
```

### Data Flow Step 42: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 51, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   51:         return escaped.toString();
```

### Data Flow Step 43: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 51, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
>>>   51:         return escaped.toString();
```

### Data Flow Step 44: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 114
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

### Data Flow Step 45: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
```

**Intermediate code within method `buildHtmlForm` (lines 372-380):**
```java
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
     377:                 .append("</NOSCRIPT>")
     378: 
     379:                 .append("</FORM></BODY></HTML>");
     380: 
     381:         return builder.toString();
```

### Data Flow Step 46: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 381, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  381:         return builder.toString();
```

### Data Flow Step 47: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 381, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  381:         return builder.toString();
```

### Data Flow Step 48: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 353, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  353:         return buildHtmlForm(actionUrl, inputTypes);
```

### Data Flow Step 49: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 331, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
```

### Data Flow Step 50: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
```

### Data Flow Step 51: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 169, Column 20
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
>>>  169:             return str;
```

### Data Flow Step 52: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
```

**Intermediate code within method `sendSaml` (lines 46-49):**
```java
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
      50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 53: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 50, Column 62
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 54: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 50, Column 62
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
>>>   50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```
