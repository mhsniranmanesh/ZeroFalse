# Vulnerability: java/xss
## Message: Cross-site scripting vulnerability due to a [user-provided value](1).
Cross-site scripting vulnerability due to a [user-provided value](2).
Cross-site scripting vulnerability due to a [user-provided value](3).

## Code Flow 1

### Thread Flow 1

### Data Flow Step 1: adapters/oidc/spring-security/src/main/java/org/keycloak/adapters/springsecurity/facade/WrappedHttpServletRequest.java, Line 59, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/oidc/spring-security/src/main/java/org/keycloak/adapters/springsecurity/facade/WrappedHttpServletRequest.java
```java
      54:         this.request = request;
      55:     }
      56: 
      57:     @Override
      58:     public String getFirstParam(String param) {
>>>   59:         return request.getParameter(param);
      60:     }
      61: 
      62:     @Override
      63:     public String getMethod() {
      64:         return request.getMethod();
```

### Data Flow Step 2: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java, Line 40, Column 29
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java
```java
      35: 
      36:     @Override
      37:     public AuthOutcome handle(OnSessionCreated onCreateSession) {
      38:         String samlRequest = facade.getRequest().getFirstParam(GeneralConstants.SAML_REQUEST_KEY);
      39:         String samlResponse = facade.getRequest().getFirstParam(GeneralConstants.SAML_RESPONSE_KEY);
>>>   40:         String relayState = facade.getRequest().getFirstParam(GeneralConstants.RELAY_STATE);
      41:         if (samlRequest != null) {
      42:             return handleSamlRequest(samlRequest, relayState);
      43:         } else if (samlResponse != null) {
      44:             return handleSamlResponse(samlResponse, relayState, onCreateSession);
      45:         }
```

### Data Flow Step 3: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java, Line 42, Column 51
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java
```java
      37:     public AuthOutcome handle(OnSessionCreated onCreateSession) {
      38:         String samlRequest = facade.getRequest().getFirstParam(GeneralConstants.SAML_REQUEST_KEY);
      39:         String samlResponse = facade.getRequest().getFirstParam(GeneralConstants.SAML_RESPONSE_KEY);
      40:         String relayState = facade.getRequest().getFirstParam(GeneralConstants.RELAY_STATE);
      41:         if (samlRequest != null) {
>>>   42:             return handleSamlRequest(samlRequest, relayState);
      43:         } else if (samlResponse != null) {
      44:             return handleSamlResponse(samlResponse, relayState, onCreateSession);
      45:         }
      46:         return AuthOutcome.NOT_ATTEMPTED;
      47: 
```

### Data Flow Step 4: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 163, Column 65
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
     158:     @Override
     159:     public AuthChallenge getChallenge() {
     160:         return this.challenge;
     161:     }
     162: 
>>>  163:     protected AuthOutcome handleSamlRequest(String samlRequest, String relayState) {
     164:         SAMLDocumentHolder holder = null;
     165:         boolean postBinding = false;
     166:         String requestUri = facade.getRequest().getURI();
     167:         if (facade.getRequest().getMethod().equalsIgnoreCase("GET")) {
     168:             // strip out query params
```

### Data Flow Step 5: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 202, Column 42
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
     197:                     log.error("Failed to verify saml request signature", e);
     198:                     return failedTerminal();
     199:                 }
     200:             }
     201:             LogoutRequestType logout = (LogoutRequestType) requestAbstractType;
>>>  202:             return logoutRequest(logout, relayState);
     203: 
     204:         } else {
     205:             log.error("unknown SAML request type");
     206:             return failedTerminal();
     207:         }
```

### Data Flow Step 6: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 68, Column 68
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
      63: 
      64:         return AuthOutcome.AUTHENTICATED;
      65:     }
      66: 
      67:     @Override
>>>   68:     protected AuthOutcome logoutRequest(LogoutRequestType request, String relayState) {
      69:         if (request.getSessionIndex() == null || request.getSessionIndex().isEmpty()) {
      70:             sessionStore.logoutByPrincipal(request.getNameID().getValue());
      71:         } else {
      72:             sessionStore.logoutBySsoId(request.getSessionIndex());
      73:         }
```

### Data Flow Step 7: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 80, Column 84
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
      75:         String issuerURL = deployment.getEntityID();
      76:         SAML2LogoutResponseBuilder builder = new SAML2LogoutResponseBuilder();
      77:         builder.logoutRequestID(request.getID());
      78:         builder.destination(deployment.getIDP().getSingleLogoutService().getResponseBindingUrl());
      79:         builder.issuer(issuerURL);
>>>   80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
      81:         if (deployment.getIDP().getSingleLogoutService().signResponse()) {
      82:             if (deployment.getSignatureCanonicalizationMethod() != null)
      83:                 binding.canonicalizationMethod(deployment.getSignatureCanonicalizationMethod());
      84:             binding.signatureAlgorithm(deployment.getSignatureAlgorithm())
      85:                     .signWith(null, deployment.getSigningKeyPair())
```

### Data Flow Step 8: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 139, Column 25
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     134:     public T encryptionKeySize(int size) {
     135:         this.encryptionKeySize = size;
     136:         return (T)this;
     137:     }
     138: 
>>>  139:     public T relayState(String relayState) {
     140:         this.relayState = relayState;
     141:         return (T)this;
     142:     }
     143: 
     144:     public class BasePostBindingBuilder {
```

### Data Flow Step 9: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 140, Column 27
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     135:         this.encryptionKeySize = size;
     136:         return (T)this;
     137:     }
     138: 
     139:     public T relayState(String relayState) {
>>>  140:         this.relayState = relayState;
     141:         return (T)this;
     142:     }
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
```

### Data Flow Step 10: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 140, Column 9
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     135:         this.encryptionKeySize = size;
     136:         return (T)this;
     137:     }
     138: 
     139:     public T relayState(String relayState) {
>>>  140:         this.relayState = relayState;
     141:         return (T)this;
     142:     }
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
```

### Data Flow Step 11: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 141, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     136:         return (T)this;
     137:     }
     138: 
     139:     public T relayState(String relayState) {
     140:         this.relayState = relayState;
>>>  141:         return (T)this;
     142:     }
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
```

### Data Flow Step 12: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 80, Column 43
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
      75:         String issuerURL = deployment.getEntityID();
      76:         SAML2LogoutResponseBuilder builder = new SAML2LogoutResponseBuilder();
      77:         builder.logoutRequestID(request.getID());
      78:         builder.destination(deployment.getIDP().getSingleLogoutService().getResponseBindingUrl());
      79:         builder.issuer(issuerURL);
>>>   80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
      81:         if (deployment.getIDP().getSingleLogoutService().signResponse()) {
      82:             if (deployment.getSignatureCanonicalizationMethod() != null)
      83:                 binding.canonicalizationMethod(deployment.getSignatureCanonicalizationMethod());
      84:             binding.signatureAlgorithm(deployment.getSignatureAlgorithm())
      85:                     .signWith(null, deployment.getSigningKeyPair())
```

### Data Flow Step 13: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 93, Column 116
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
      88:             //   <related DocumentBuilder>.addExtension(new KeycloakKeySamlExtensionGenerator(<key ID>));
      89:         }
      90: 
      91: 
      92:         try {
>>>   93:             SamlUtil.sendSaml(false, facade, deployment.getIDP().getSingleLogoutService().getResponseBindingUrl(), binding, builder.buildDocument(),
      94:                     deployment.getIDP().getSingleLogoutService().getResponseBinding());
      95:         } catch (Exception e) {
      96:             log.error("Could not send logout response SAML request", e);
      97:             return AuthOutcome.FAILED;
      98:         }
```

### Data Flow Step 14: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 42, Column 29
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      37: public class SamlUtil {
      38: 
      39:     protected static Logger log = Logger.getLogger(SamlUtil.class);
      40: 
      41:     public static void sendSaml(boolean asRequest, HttpFacade httpFacade, String actionUrl,
>>>   42:                             BaseSAML2BindingBuilder binding, Document document,
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
      45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
```

### Data Flow Step 15: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      40: 
      41:     public static void sendSaml(boolean asRequest, HttpFacade httpFacade, String actionUrl,
      42:                             BaseSAML2BindingBuilder binding, Document document,
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
      50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 16: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 242, Column 35
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     237:     public BaseRedirectBindingBuilder redirectBinding(Document document) throws ProcessingException {
     238:         return new BaseRedirectBindingBuilder(this, document);
     239: 
     240:     }
     241: 
>>>  242:     public BasePostBindingBuilder postBinding(Document document) throws ProcessingException {
     243:         return new BasePostBindingBuilder(this, document);
     244: 
     245:     }
     246: 
     247:     public BaseSoapBindingBuilder soapBinding(Document document) throws ProcessingException {
```

### Data Flow Step 17: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 243, Column 43
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     238:         return new BaseRedirectBindingBuilder(this, document);
     239: 
     240:     }
     241: 
     242:     public BasePostBindingBuilder postBinding(Document document) throws ProcessingException {
>>>  243:         return new BasePostBindingBuilder(this, document);
     244: 
     245:     }
     246: 
     247:     public BaseSoapBindingBuilder soapBinding(Document document) throws ProcessingException {
     248:         return new BaseSoapBindingBuilder(this, document);
```

### Data Flow Step 18: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 148, Column 39
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
     147: 
>>>  148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
     149:             this.builder = builder;
     150:             this.document = document;
     151:             if (builder.signAssertions) {
     152:                 builder.signAssertion(document);
     153:             }
```

### Data Flow Step 19: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 149, Column 28
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
     147: 
     148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
>>>  149:             this.builder = builder;
     150:             this.document = document;
     151:             if (builder.signAssertions) {
     152:                 builder.signAssertion(document);
     153:             }
     154:             if (builder.encrypt) builder.encryptDocument(document);
```

### Data Flow Step 20: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 149, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
     147: 
     148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
>>>  149:             this.builder = builder;
     150:             this.document = document;
     151:             if (builder.signAssertions) {
     152:                 builder.signAssertion(document);
     153:             }
     154:             if (builder.encrypt) builder.encryptDocument(document);
```

### Data Flow Step 21: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 148, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
     147: 
>>>  148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
     149:             this.builder = builder;
     150:             this.document = document;
     151:             if (builder.signAssertions) {
     152:                 builder.signAssertion(document);
     153:             }
```

### Data Flow Step 22: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 243, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     238:         return new BaseRedirectBindingBuilder(this, document);
     239: 
     240:     }
     241: 
     242:     public BasePostBindingBuilder postBinding(Document document) throws ProcessingException {
>>>  243:         return new BasePostBindingBuilder(this, document);
     244: 
     245:     }
     246: 
     247:     public BaseSoapBindingBuilder soapBinding(Document document) throws ProcessingException {
     248:         return new BaseSoapBindingBuilder(this, document);
```

### Data Flow Step 23: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      40: 
      41:     public static void sendSaml(boolean asRequest, HttpFacade httpFacade, String actionUrl,
      42:                             BaseSAML2BindingBuilder binding, Document document,
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
      50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 24: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 167, Column 23
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     162:             return PostBindingUtil.base64Encode(new String(responseBytes, GeneralConstants.SAML_CHARSET));
     163:         }
     164:         public Document getDocument() {
     165:             return document;
     166:         }
>>>  167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
     169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
```

### Data Flow Step 25: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     163:         }
     164:         public Document getDocument() {
     165:             return document;
     166:         }
     167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
     169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
     173:             return str;
```

### Data Flow Step 26: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     163:         }
     164:         public Document getDocument() {
     165:             return document;
     166:         }
     167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
     169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
     173:             return str;
```

### Data Flow Step 27: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 330, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     325:         Element parentNode = (Element) originalAssertionElement.getParentNode();
     326: 
     327:         parentNode.replaceChild(clonedAssertionElement, originalAssertionElement);
     328:     }
     329: 
>>>  330:     public String buildHtmlPostResponse(Document responseDoc, String actionUrl, boolean asRequest) throws ProcessingException, ConfigurationException, IOException {
     331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
     332:     }
     333: 
     334:     public static String getSAMLResponse(Document responseDoc) throws ProcessingException, ConfigurationException, IOException {
     335:         byte[] responseBytes = org.keycloak.saml.common.util.DocumentUtil.getDocumentAsString(responseDoc).getBytes(GeneralConstants.SAML_CHARSET);
```

### Data Flow Step 28: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 331, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     326: 
     327:         parentNode.replaceChild(clonedAssertionElement, originalAssertionElement);
     328:     }
     329: 
     330:     public String buildHtmlPostResponse(Document responseDoc, String actionUrl, boolean asRequest) throws ProcessingException, ConfigurationException, IOException {
>>>  331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
     332:     }
     333: 
     334:     public static String getSAMLResponse(Document responseDoc) throws ProcessingException, ConfigurationException, IOException {
     335:         byte[] responseBytes = org.keycloak.saml.common.util.DocumentUtil.getDocumentAsString(responseDoc).getBytes(GeneralConstants.SAML_CHARSET);
     336:         return PostBindingUtil.base64Encode(new String(responseBytes, GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 29: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 339, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     334:     public static String getSAMLResponse(Document responseDoc) throws ProcessingException, ConfigurationException, IOException {
     335:         byte[] responseBytes = org.keycloak.saml.common.util.DocumentUtil.getDocumentAsString(responseDoc).getBytes(GeneralConstants.SAML_CHARSET);
     336:         return PostBindingUtil.base64Encode(new String(responseBytes, GeneralConstants.SAML_CHARSET));
     337:     }
     338: 
>>>  339:     public String buildHtml(String samlResponse, String actionUrl, boolean asRequest) {
     340: 
     341:         String key = GeneralConstants.SAML_RESPONSE_KEY;
     342: 
     343:         if (asRequest) {
     344:             key = GeneralConstants.SAML_REQUEST_KEY;
```

### Data Flow Step 30: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 58
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     345:         }
     346: 
     347:         Map<String, String> inputTypes = new HashMap<>();
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
```

### Data Flow Step 31: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 58
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     345:         }
     346: 
     347:         Map<String, String> inputTypes = new HashMap<>();
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
```

### Data Flow Step 32: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     345:         }
     346: 
     347:         Map<String, String> inputTypes = new HashMap<>();
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
```

### Data Flow Step 33: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 353, Column 41
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
     350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
>>>  353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
     356:     public String buildHtmlForm(String actionUrl, Map<String, String> inputTypes) {
     357:         StringBuilder builder = new StringBuilder();
     358: 
```

### Data Flow Step 34: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 356, Column 51
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
>>>  356:     public String buildHtmlForm(String actionUrl, Map<String, String> inputTypes) {
     357:         StringBuilder builder = new StringBuilder();
     358: 
     359:         builder.append("<HTML>")
     360:                 .append("<HEAD>")
     361: 
```

### Data Flow Step 35: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 130
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
```

### Data Flow Step 36: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 130
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
```

### Data Flow Step 37: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 30, Column 42
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      25:      * <p>Escapes the value for a HTML element attribute.</p>
      26:      *
      27:      * @param value
      28:      * @return
      29:      */
>>>   30:     public static String escapeAttribute(String value) {
      31:         StringBuilder escaped = new StringBuilder();
      32: 
      33:         for (int i = 0; i < value.length(); i++) {
      34:             char chr = value.charAt(i);
      35: 
```

### Data Flow Step 38: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 34, Column 24
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      29:      */
      30:     public static String escapeAttribute(String value) {
      31:         StringBuilder escaped = new StringBuilder();
      32: 
      33:         for (int i = 0; i < value.length(); i++) {
>>>   34:             char chr = value.charAt(i);
      35: 
      36:             if (chr == '<') {
      37:                 escaped.append("&lt;");
      38:             } else if (chr == '>') {
      39:                 escaped.append("&gt;");
```

### Data Flow Step 39: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 34, Column 24
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      29:      */
      30:     public static String escapeAttribute(String value) {
      31:         StringBuilder escaped = new StringBuilder();
      32: 
      33:         for (int i = 0; i < value.length(); i++) {
>>>   34:             char chr = value.charAt(i);
      35: 
      36:             if (chr == '<') {
      37:                 escaped.append("&lt;");
      38:             } else if (chr == '>') {
      39:                 escaped.append("&gt;");
```

### Data Flow Step 40: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 47, Column 32
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      42:             } else if (chr == '\'') {
      43:                 escaped.append("&apos;");
      44:             } else if (chr == '&') {
      45:                 escaped.append("&amp;");
      46:             } else {
>>>   47:                 escaped.append(chr);
      48:             }
      49:         }
      50: 
      51:         return escaped.toString();
      52:     }
```

### Data Flow Step 41: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 47, Column 17
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      42:             } else if (chr == '\'') {
      43:                 escaped.append("&apos;");
      44:             } else if (chr == '&') {
      45:                 escaped.append("&amp;");
      46:             } else {
>>>   47:                 escaped.append(chr);
      48:             }
      49:         }
      50: 
      51:         return escaped.toString();
      52:     }
```

### Data Flow Step 42: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 51, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      46:             } else {
      47:                 escaped.append(chr);
      48:             }
      49:         }
      50: 
>>>   51:         return escaped.toString();
      52:     }
      53: 
      54: }
```

### Data Flow Step 43: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 51, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      46:             } else {
      47:                 escaped.append(chr);
      48:             }
      49:         }
      50: 
>>>   51:         return escaped.toString();
      52:     }
      53: 
      54: }
```

### Data Flow Step 44: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 114
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
```

### Data Flow Step 45: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
```

### Data Flow Step 46: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 381, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
     377:                 .append("</NOSCRIPT>")
     378: 
     379:                 .append("</FORM></BODY></HTML>");
     380: 
>>>  381:         return builder.toString();
     382:     }
     383: 
     384: 
     385:     public String base64Encoded(Document document) throws ConfigurationException, ProcessingException, IOException  {
     386:         String documentAsString = DocumentUtil.getDocumentAsString(document);
```

### Data Flow Step 47: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 381, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
     377:                 .append("</NOSCRIPT>")
     378: 
     379:                 .append("</FORM></BODY></HTML>");
     380: 
>>>  381:         return builder.toString();
     382:     }
     383: 
     384: 
     385:     public String base64Encoded(Document document) throws ConfigurationException, ProcessingException, IOException  {
     386:         String documentAsString = DocumentUtil.getDocumentAsString(document);
```

### Data Flow Step 48: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 353, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
     350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
>>>  353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
     356:     public String buildHtmlForm(String actionUrl, Map<String, String> inputTypes) {
     357:         StringBuilder builder = new StringBuilder();
     358: 
```

### Data Flow Step 49: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 331, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     326: 
     327:         parentNode.replaceChild(clonedAssertionElement, originalAssertionElement);
     328:     }
     329: 
     330:     public String buildHtmlPostResponse(Document responseDoc, String actionUrl, boolean asRequest) throws ProcessingException, ConfigurationException, IOException {
>>>  331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
     332:     }
     333: 
     334:     public static String getSAMLResponse(Document responseDoc) throws ProcessingException, ConfigurationException, IOException {
     335:         byte[] responseBytes = org.keycloak.saml.common.util.DocumentUtil.getDocumentAsString(responseDoc).getBytes(GeneralConstants.SAML_CHARSET);
     336:         return PostBindingUtil.base64Encode(new String(responseBytes, GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 50: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     163:         }
     164:         public Document getDocument() {
     165:             return document;
     166:         }
     167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
     169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
     173:             return str;
```

### Data Flow Step 51: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 169, Column 20
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     164:         public Document getDocument() {
     165:             return document;
     166:         }
     167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
>>>  169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
     173:             return str;
     174:         }
```

### Data Flow Step 52: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      40: 
      41:     public static void sendSaml(boolean asRequest, HttpFacade httpFacade, String actionUrl,
      42:                             BaseSAML2BindingBuilder binding, Document document,
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
      50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 53: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 50, Column 62
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
>>>   50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
      51:             httpFacade.getResponse().end();
      52:         } else {
      53:             String uri = asRequest ? binding.redirectBinding(document).requestURI(actionUrl).toString() : binding.redirectBinding(document).responseURI(actionUrl).toString();
      54:             httpFacade.getResponse().setStatus(302);
      55:             httpFacade.getResponse().setHeader("Location", uri);
```

### Data Flow Step 54: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 50, Column 62
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
>>>   50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
      51:             httpFacade.getResponse().end();
      52:         } else {
      53:             String uri = asRequest ? binding.redirectBinding(document).requestURI(actionUrl).toString() : binding.redirectBinding(document).responseURI(actionUrl).toString();
      54:             httpFacade.getResponse().setStatus(302);
      55:             httpFacade.getResponse().setHeader("Location", uri);
```

## Code Flow 2

### Thread Flow 1

### Data Flow Step 1: adapters/oidc/spring-security/src/main/java/org/keycloak/adapters/springsecurity/facade/WrappedHttpServletRequest.java, Line 59, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/oidc/spring-security/src/main/java/org/keycloak/adapters/springsecurity/facade/WrappedHttpServletRequest.java
```java
      54:         this.request = request;
      55:     }
      56: 
      57:     @Override
      58:     public String getFirstParam(String param) {
>>>   59:         return request.getParameter(param);
      60:     }
      61: 
      62:     @Override
      63:     public String getMethod() {
      64:         return request.getMethod();
```

### Data Flow Step 2: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 53, Column 17
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
      48: 
      49:     @Override
      50:     public AuthOutcome handle(OnSessionCreated onCreateSession) {
      51:         return doHandle(new SamlInvocationContext(facade.getRequest().getFirstParam(GeneralConstants.SAML_REQUEST_KEY),
      52:                 facade.getRequest().getFirstParam(GeneralConstants.SAML_RESPONSE_KEY),
>>>   53:                 facade.getRequest().getFirstParam(GeneralConstants.RELAY_STATE)), onCreateSession);
      54:     }
      55: 
      56:     @Override
      57:     protected AuthOutcome handleRequest() {
      58:         boolean globalLogout = "true".equals(facade.getRequest().getQueryParamValue("GLO"));
```

### Data Flow Step 3: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java, Line 33, Column 75
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java
```java
      28: 
      29:     public SamlInvocationContext() {
      30:         this(null, null, null);
      31:     }
      32: 
>>>   33:     public SamlInvocationContext(String samlRequest, String samlResponse, String relayState) {
      34:         this.samlRequest = samlRequest;
      35:         this.samlResponse = samlResponse;
      36:         this.relayState = relayState;
      37:     }
      38: 
```

### Data Flow Step 4: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java, Line 36, Column 27
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java
```java
      31:     }
      32: 
      33:     public SamlInvocationContext(String samlRequest, String samlResponse, String relayState) {
      34:         this.samlRequest = samlRequest;
      35:         this.samlResponse = samlResponse;
>>>   36:         this.relayState = relayState;
      37:     }
      38: 
      39:     public String getSamlRequest() {
      40:         return this.samlRequest;
      41:     }
```

### Data Flow Step 5: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java, Line 36, Column 9
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java
```java
      31:     }
      32: 
      33:     public SamlInvocationContext(String samlRequest, String samlResponse, String relayState) {
      34:         this.samlRequest = samlRequest;
      35:         this.samlResponse = samlResponse;
>>>   36:         this.relayState = relayState;
      37:     }
      38: 
      39:     public String getSamlRequest() {
      40:         return this.samlRequest;
      41:     }
```

### Data Flow Step 6: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java, Line 33, Column 12
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java
```java
      28: 
      29:     public SamlInvocationContext() {
      30:         this(null, null, null);
      31:     }
      32: 
>>>   33:     public SamlInvocationContext(String samlRequest, String samlResponse, String relayState) {
      34:         this.samlRequest = samlRequest;
      35:         this.samlResponse = samlResponse;
      36:         this.relayState = relayState;
      37:     }
      38: 
```

### Data Flow Step 7: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 51, Column 25
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
      46:         super(facade, deployment, sessionStore);
      47:     }
      48: 
      49:     @Override
      50:     public AuthOutcome handle(OnSessionCreated onCreateSession) {
>>>   51:         return doHandle(new SamlInvocationContext(facade.getRequest().getFirstParam(GeneralConstants.SAML_REQUEST_KEY),
      52:                 facade.getRequest().getFirstParam(GeneralConstants.SAML_RESPONSE_KEY),
      53:                 facade.getRequest().getFirstParam(GeneralConstants.RELAY_STATE)), onCreateSession);
      54:     }
      55: 
      56:     @Override
```

### Data Flow Step 8: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 138, Column 33
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
     133:         this.facade = facade;
     134:         this.deployment = deployment;
     135:         this.sessionStore = sessionStore;
     136:     }
     137: 
>>>  138:     public AuthOutcome doHandle(SamlInvocationContext context, OnSessionCreated onCreateSession) {
     139:         String samlRequest = context.getSamlRequest();
     140:         String samlResponse = context.getSamlResponse();
     141:         String relayState = context.getRelayState();
     142:         if (samlRequest != null) {
     143:             return handleSamlRequest(samlRequest, relayState);
```

### Data Flow Step 9: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 141, Column 29
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
     136:     }
     137: 
     138:     public AuthOutcome doHandle(SamlInvocationContext context, OnSessionCreated onCreateSession) {
     139:         String samlRequest = context.getSamlRequest();
     140:         String samlResponse = context.getSamlResponse();
>>>  141:         String relayState = context.getRelayState();
     142:         if (samlRequest != null) {
     143:             return handleSamlRequest(samlRequest, relayState);
     144:         } else if (samlResponse != null) {
     145:             return handleSamlResponse(samlResponse, relayState, onCreateSession);
     146:         } else if (sessionStore.isLoggedIn()) {
```

### Data Flow Step 10: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java, Line 47, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java
```java
      42: 
      43:     public String getSamlResponse() {
      44:         return this.samlResponse;
      45:     }
      46: 
>>>   47:     public String getRelayState() {
      48:         return this.relayState;
      49:     }
      50: }
```

### Data Flow Step 11: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java, Line 48, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java
```java
      43:     public String getSamlResponse() {
      44:         return this.samlResponse;
      45:     }
      46: 
      47:     public String getRelayState() {
>>>   48:         return this.relayState;
      49:     }
      50: }
```

### Data Flow Step 12: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java, Line 48, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/SamlInvocationContext.java
```java
      43:     public String getSamlResponse() {
      44:         return this.samlResponse;
      45:     }
      46: 
      47:     public String getRelayState() {
>>>   48:         return this.relayState;
      49:     }
      50: }
```

### Data Flow Step 13: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 141, Column 29
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
     136:     }
     137: 
     138:     public AuthOutcome doHandle(SamlInvocationContext context, OnSessionCreated onCreateSession) {
     139:         String samlRequest = context.getSamlRequest();
     140:         String samlResponse = context.getSamlResponse();
>>>  141:         String relayState = context.getRelayState();
     142:         if (samlRequest != null) {
     143:             return handleSamlRequest(samlRequest, relayState);
     144:         } else if (samlResponse != null) {
     145:             return handleSamlResponse(samlResponse, relayState, onCreateSession);
     146:         } else if (sessionStore.isLoggedIn()) {
```

### Data Flow Step 14: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 143, Column 51
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
     138:     public AuthOutcome doHandle(SamlInvocationContext context, OnSessionCreated onCreateSession) {
     139:         String samlRequest = context.getSamlRequest();
     140:         String samlResponse = context.getSamlResponse();
     141:         String relayState = context.getRelayState();
     142:         if (samlRequest != null) {
>>>  143:             return handleSamlRequest(samlRequest, relayState);
     144:         } else if (samlResponse != null) {
     145:             return handleSamlResponse(samlResponse, relayState, onCreateSession);
     146:         } else if (sessionStore.isLoggedIn()) {
     147:             if (verifySSL()) return failedTerminal();
     148:             log.debug("AUTHENTICATED: was cached");
```

### Data Flow Step 15: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 163, Column 65
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
     158:     @Override
     159:     public AuthChallenge getChallenge() {
     160:         return this.challenge;
     161:     }
     162: 
>>>  163:     protected AuthOutcome handleSamlRequest(String samlRequest, String relayState) {
     164:         SAMLDocumentHolder holder = null;
     165:         boolean postBinding = false;
     166:         String requestUri = facade.getRequest().getURI();
     167:         if (facade.getRequest().getMethod().equalsIgnoreCase("GET")) {
     168:             // strip out query params
```

### Data Flow Step 16: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 202, Column 42
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
     197:                     log.error("Failed to verify saml request signature", e);
     198:                     return failedTerminal();
     199:                 }
     200:             }
     201:             LogoutRequestType logout = (LogoutRequestType) requestAbstractType;
>>>  202:             return logoutRequest(logout, relayState);
     203: 
     204:         } else {
     205:             log.error("unknown SAML request type");
     206:             return failedTerminal();
     207:         }
```

### Data Flow Step 17: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 68, Column 68
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
      63: 
      64:         return AuthOutcome.AUTHENTICATED;
      65:     }
      66: 
      67:     @Override
>>>   68:     protected AuthOutcome logoutRequest(LogoutRequestType request, String relayState) {
      69:         if (request.getSessionIndex() == null || request.getSessionIndex().isEmpty()) {
      70:             sessionStore.logoutByPrincipal(request.getNameID().getValue());
      71:         } else {
      72:             sessionStore.logoutBySsoId(request.getSessionIndex());
      73:         }
```

### Data Flow Step 18: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 80, Column 84
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
      75:         String issuerURL = deployment.getEntityID();
      76:         SAML2LogoutResponseBuilder builder = new SAML2LogoutResponseBuilder();
      77:         builder.logoutRequestID(request.getID());
      78:         builder.destination(deployment.getIDP().getSingleLogoutService().getResponseBindingUrl());
      79:         builder.issuer(issuerURL);
>>>   80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
      81:         if (deployment.getIDP().getSingleLogoutService().signResponse()) {
      82:             if (deployment.getSignatureCanonicalizationMethod() != null)
      83:                 binding.canonicalizationMethod(deployment.getSignatureCanonicalizationMethod());
      84:             binding.signatureAlgorithm(deployment.getSignatureAlgorithm())
      85:                     .signWith(null, deployment.getSigningKeyPair())
```

### Data Flow Step 19: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 139, Column 25
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     134:     public T encryptionKeySize(int size) {
     135:         this.encryptionKeySize = size;
     136:         return (T)this;
     137:     }
     138: 
>>>  139:     public T relayState(String relayState) {
     140:         this.relayState = relayState;
     141:         return (T)this;
     142:     }
     143: 
     144:     public class BasePostBindingBuilder {
```

### Data Flow Step 20: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 140, Column 27
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     135:         this.encryptionKeySize = size;
     136:         return (T)this;
     137:     }
     138: 
     139:     public T relayState(String relayState) {
>>>  140:         this.relayState = relayState;
     141:         return (T)this;
     142:     }
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
```

### Data Flow Step 21: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 140, Column 9
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     135:         this.encryptionKeySize = size;
     136:         return (T)this;
     137:     }
     138: 
     139:     public T relayState(String relayState) {
>>>  140:         this.relayState = relayState;
     141:         return (T)this;
     142:     }
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
```

### Data Flow Step 22: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 141, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     136:         return (T)this;
     137:     }
     138: 
     139:     public T relayState(String relayState) {
     140:         this.relayState = relayState;
>>>  141:         return (T)this;
     142:     }
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
```

### Data Flow Step 23: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 80, Column 43
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
      75:         String issuerURL = deployment.getEntityID();
      76:         SAML2LogoutResponseBuilder builder = new SAML2LogoutResponseBuilder();
      77:         builder.logoutRequestID(request.getID());
      78:         builder.destination(deployment.getIDP().getSingleLogoutService().getResponseBindingUrl());
      79:         builder.issuer(issuerURL);
>>>   80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
      81:         if (deployment.getIDP().getSingleLogoutService().signResponse()) {
      82:             if (deployment.getSignatureCanonicalizationMethod() != null)
      83:                 binding.canonicalizationMethod(deployment.getSignatureCanonicalizationMethod());
      84:             binding.signatureAlgorithm(deployment.getSignatureAlgorithm())
      85:                     .signWith(null, deployment.getSigningKeyPair())
```

### Data Flow Step 24: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 93, Column 116
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
      88:             //   <related DocumentBuilder>.addExtension(new KeycloakKeySamlExtensionGenerator(<key ID>));
      89:         }
      90: 
      91: 
      92:         try {
>>>   93:             SamlUtil.sendSaml(false, facade, deployment.getIDP().getSingleLogoutService().getResponseBindingUrl(), binding, builder.buildDocument(),
      94:                     deployment.getIDP().getSingleLogoutService().getResponseBinding());
      95:         } catch (Exception e) {
      96:             log.error("Could not send logout response SAML request", e);
      97:             return AuthOutcome.FAILED;
      98:         }
```

### Data Flow Step 25: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 42, Column 29
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      37: public class SamlUtil {
      38: 
      39:     protected static Logger log = Logger.getLogger(SamlUtil.class);
      40: 
      41:     public static void sendSaml(boolean asRequest, HttpFacade httpFacade, String actionUrl,
>>>   42:                             BaseSAML2BindingBuilder binding, Document document,
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
      45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
```

### Data Flow Step 26: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      40: 
      41:     public static void sendSaml(boolean asRequest, HttpFacade httpFacade, String actionUrl,
      42:                             BaseSAML2BindingBuilder binding, Document document,
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
      50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 27: services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java, Line 121, Column 31
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java
```java
     116:     public RedirectBindingBuilder redirectBinding(Document document) throws ProcessingException  {
     117:         return new RedirectBindingBuilder(this, document);
     118:     }
     119: 
     120:     @Override
>>>  121:     public PostBindingBuilder postBinding(Document document) throws ProcessingException  {
     122:         return new PostBindingBuilder(this, document);
     123:     }
     124: 
     125:     @Override
     126:     public SoapBindingBuilder soapBinding(Document document) throws ProcessingException {
```

### Data Flow Step 28: services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java, Line 122, Column 39
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java
```java
     117:         return new RedirectBindingBuilder(this, document);
     118:     }
     119: 
     120:     @Override
     121:     public PostBindingBuilder postBinding(Document document) throws ProcessingException  {
>>>  122:         return new PostBindingBuilder(this, document);
     123:     }
     124: 
     125:     @Override
     126:     public SoapBindingBuilder soapBinding(Document document) throws ProcessingException {
     127:         return new SoapBindingBuilder(this, document);
```

### Data Flow Step 29: services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java, Line 49, Column 35
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java
```java
      44:     public JaxrsSAML2BindingBuilder(KeycloakSession session) {
      45:         this.session = session;
      46:     }
      47: 
      48:     public class PostBindingBuilder extends BasePostBindingBuilder {
>>>   49:         public PostBindingBuilder(JaxrsSAML2BindingBuilder builder, Document document) throws ProcessingException {
      50:             super(builder, document);
      51:         }
      52: 
      53:         public Response request(String actionUrl) throws ConfigurationException, ProcessingException, IOException {
      54:             return createResponse(actionUrl, GeneralConstants.SAML_REQUEST_KEY);
```

### Data Flow Step 30: services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java, Line 50, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java
```java
      45:         this.session = session;
      46:     }
      47: 
      48:     public class PostBindingBuilder extends BasePostBindingBuilder {
      49:         public PostBindingBuilder(JaxrsSAML2BindingBuilder builder, Document document) throws ProcessingException {
>>>   50:             super(builder, document);
      51:         }
      52: 
      53:         public Response request(String actionUrl) throws ConfigurationException, ProcessingException, IOException {
      54:             return createResponse(actionUrl, GeneralConstants.SAML_REQUEST_KEY);
      55:         }
```

### Data Flow Step 31: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 148, Column 39
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
     147: 
>>>  148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
     149:             this.builder = builder;
     150:             this.document = document;
     151:             if (builder.signAssertions) {
     152:                 builder.signAssertion(document);
     153:             }
```

### Data Flow Step 32: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 149, Column 28
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
     147: 
     148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
>>>  149:             this.builder = builder;
     150:             this.document = document;
     151:             if (builder.signAssertions) {
     152:                 builder.signAssertion(document);
     153:             }
     154:             if (builder.encrypt) builder.encryptDocument(document);
```

### Data Flow Step 33: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 149, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
     147: 
     148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
>>>  149:             this.builder = builder;
     150:             this.document = document;
     151:             if (builder.signAssertions) {
     152:                 builder.signAssertion(document);
     153:             }
     154:             if (builder.encrypt) builder.encryptDocument(document);
```

### Data Flow Step 34: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 148, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
     147: 
>>>  148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
     149:             this.builder = builder;
     150:             this.document = document;
     151:             if (builder.signAssertions) {
     152:                 builder.signAssertion(document);
     153:             }
```

### Data Flow Step 35: services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java, Line 50, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java
```java
      45:         this.session = session;
      46:     }
      47: 
      48:     public class PostBindingBuilder extends BasePostBindingBuilder {
      49:         public PostBindingBuilder(JaxrsSAML2BindingBuilder builder, Document document) throws ProcessingException {
>>>   50:             super(builder, document);
      51:         }
      52: 
      53:         public Response request(String actionUrl) throws ConfigurationException, ProcessingException, IOException {
      54:             return createResponse(actionUrl, GeneralConstants.SAML_REQUEST_KEY);
      55:         }
```

### Data Flow Step 36: services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java, Line 49, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java
```java
      44:     public JaxrsSAML2BindingBuilder(KeycloakSession session) {
      45:         this.session = session;
      46:     }
      47: 
      48:     public class PostBindingBuilder extends BasePostBindingBuilder {
>>>   49:         public PostBindingBuilder(JaxrsSAML2BindingBuilder builder, Document document) throws ProcessingException {
      50:             super(builder, document);
      51:         }
      52: 
      53:         public Response request(String actionUrl) throws ConfigurationException, ProcessingException, IOException {
      54:             return createResponse(actionUrl, GeneralConstants.SAML_REQUEST_KEY);
```

### Data Flow Step 37: services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java, Line 122, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/services/src/main/java/org/keycloak/protocol/saml/JaxrsSAML2BindingBuilder.java
```java
     117:         return new RedirectBindingBuilder(this, document);
     118:     }
     119: 
     120:     @Override
     121:     public PostBindingBuilder postBinding(Document document) throws ProcessingException  {
>>>  122:         return new PostBindingBuilder(this, document);
     123:     }
     124: 
     125:     @Override
     126:     public SoapBindingBuilder soapBinding(Document document) throws ProcessingException {
     127:         return new SoapBindingBuilder(this, document);
```

### Data Flow Step 38: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      40: 
      41:     public static void sendSaml(boolean asRequest, HttpFacade httpFacade, String actionUrl,
      42:                             BaseSAML2BindingBuilder binding, Document document,
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
      50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 39: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 167, Column 23
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     162:             return PostBindingUtil.base64Encode(new String(responseBytes, GeneralConstants.SAML_CHARSET));
     163:         }
     164:         public Document getDocument() {
     165:             return document;
     166:         }
>>>  167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
     169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
```

### Data Flow Step 40: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     163:         }
     164:         public Document getDocument() {
     165:             return document;
     166:         }
     167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
     169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
     173:             return str;
```

### Data Flow Step 41: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     163:         }
     164:         public Document getDocument() {
     165:             return document;
     166:         }
     167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
     169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
     173:             return str;
```

### Data Flow Step 42: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 330, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     325:         Element parentNode = (Element) originalAssertionElement.getParentNode();
     326: 
     327:         parentNode.replaceChild(clonedAssertionElement, originalAssertionElement);
     328:     }
     329: 
>>>  330:     public String buildHtmlPostResponse(Document responseDoc, String actionUrl, boolean asRequest) throws ProcessingException, ConfigurationException, IOException {
     331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
     332:     }
     333: 
     334:     public static String getSAMLResponse(Document responseDoc) throws ProcessingException, ConfigurationException, IOException {
     335:         byte[] responseBytes = org.keycloak.saml.common.util.DocumentUtil.getDocumentAsString(responseDoc).getBytes(GeneralConstants.SAML_CHARSET);
```

### Data Flow Step 43: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 331, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     326: 
     327:         parentNode.replaceChild(clonedAssertionElement, originalAssertionElement);
     328:     }
     329: 
     330:     public String buildHtmlPostResponse(Document responseDoc, String actionUrl, boolean asRequest) throws ProcessingException, ConfigurationException, IOException {
>>>  331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
     332:     }
     333: 
     334:     public static String getSAMLResponse(Document responseDoc) throws ProcessingException, ConfigurationException, IOException {
     335:         byte[] responseBytes = org.keycloak.saml.common.util.DocumentUtil.getDocumentAsString(responseDoc).getBytes(GeneralConstants.SAML_CHARSET);
     336:         return PostBindingUtil.base64Encode(new String(responseBytes, GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 44: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 339, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     334:     public static String getSAMLResponse(Document responseDoc) throws ProcessingException, ConfigurationException, IOException {
     335:         byte[] responseBytes = org.keycloak.saml.common.util.DocumentUtil.getDocumentAsString(responseDoc).getBytes(GeneralConstants.SAML_CHARSET);
     336:         return PostBindingUtil.base64Encode(new String(responseBytes, GeneralConstants.SAML_CHARSET));
     337:     }
     338: 
>>>  339:     public String buildHtml(String samlResponse, String actionUrl, boolean asRequest) {
     340: 
     341:         String key = GeneralConstants.SAML_RESPONSE_KEY;
     342: 
     343:         if (asRequest) {
     344:             key = GeneralConstants.SAML_REQUEST_KEY;
```

### Data Flow Step 45: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 349, Column 23
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     344:             key = GeneralConstants.SAML_REQUEST_KEY;
     345:         }
     346: 
     347:         Map<String, String> inputTypes = new HashMap<>();
     348:         inputTypes.put(key, samlResponse);
>>>  349:         if (isNotNull(relayState)) {
     350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
```

### Data Flow Step 46: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 349, Column 23
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     344:             key = GeneralConstants.SAML_REQUEST_KEY;
     345:         }
     346: 
     347:         Map<String, String> inputTypes = new HashMap<>();
     348:         inputTypes.put(key, samlResponse);
>>>  349:         if (isNotNull(relayState)) {
     350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
```

### Data Flow Step 47: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 58
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     345:         }
     346: 
     347:         Map<String, String> inputTypes = new HashMap<>();
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
```

### Data Flow Step 48: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     345:         }
     346: 
     347:         Map<String, String> inputTypes = new HashMap<>();
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
```

### Data Flow Step 49: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 353, Column 41
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
     350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
>>>  353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
     356:     public String buildHtmlForm(String actionUrl, Map<String, String> inputTypes) {
     357:         StringBuilder builder = new StringBuilder();
     358: 
```

### Data Flow Step 50: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 356, Column 51
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
>>>  356:     public String buildHtmlForm(String actionUrl, Map<String, String> inputTypes) {
     357:         StringBuilder builder = new StringBuilder();
     358: 
     359:         builder.append("<HTML>")
     360:                 .append("<HEAD>")
     361: 
```

### Data Flow Step 51: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 130
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
```

### Data Flow Step 52: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 130
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
```

### Data Flow Step 53: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 30, Column 42
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      25:      * <p>Escapes the value for a HTML element attribute.</p>
      26:      *
      27:      * @param value
      28:      * @return
      29:      */
>>>   30:     public static String escapeAttribute(String value) {
      31:         StringBuilder escaped = new StringBuilder();
      32: 
      33:         for (int i = 0; i < value.length(); i++) {
      34:             char chr = value.charAt(i);
      35: 
```

### Data Flow Step 54: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 34, Column 24
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      29:      */
      30:     public static String escapeAttribute(String value) {
      31:         StringBuilder escaped = new StringBuilder();
      32: 
      33:         for (int i = 0; i < value.length(); i++) {
>>>   34:             char chr = value.charAt(i);
      35: 
      36:             if (chr == '<') {
      37:                 escaped.append("&lt;");
      38:             } else if (chr == '>') {
      39:                 escaped.append("&gt;");
```

### Data Flow Step 55: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 34, Column 24
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      29:      */
      30:     public static String escapeAttribute(String value) {
      31:         StringBuilder escaped = new StringBuilder();
      32: 
      33:         for (int i = 0; i < value.length(); i++) {
>>>   34:             char chr = value.charAt(i);
      35: 
      36:             if (chr == '<') {
      37:                 escaped.append("&lt;");
      38:             } else if (chr == '>') {
      39:                 escaped.append("&gt;");
```

### Data Flow Step 56: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 47, Column 32
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      42:             } else if (chr == '\'') {
      43:                 escaped.append("&apos;");
      44:             } else if (chr == '&') {
      45:                 escaped.append("&amp;");
      46:             } else {
>>>   47:                 escaped.append(chr);
      48:             }
      49:         }
      50: 
      51:         return escaped.toString();
      52:     }
```

### Data Flow Step 57: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 47, Column 17
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      42:             } else if (chr == '\'') {
      43:                 escaped.append("&apos;");
      44:             } else if (chr == '&') {
      45:                 escaped.append("&amp;");
      46:             } else {
>>>   47:                 escaped.append(chr);
      48:             }
      49:         }
      50: 
      51:         return escaped.toString();
      52:     }
```

### Data Flow Step 58: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 51, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      46:             } else {
      47:                 escaped.append(chr);
      48:             }
      49:         }
      50: 
>>>   51:         return escaped.toString();
      52:     }
      53: 
      54: }
```

### Data Flow Step 59: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 51, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      46:             } else {
      47:                 escaped.append(chr);
      48:             }
      49:         }
      50: 
>>>   51:         return escaped.toString();
      52:     }
      53: 
      54: }
```

### Data Flow Step 60: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 114
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
```

### Data Flow Step 61: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
```

### Data Flow Step 62: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 381, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
     377:                 .append("</NOSCRIPT>")
     378: 
     379:                 .append("</FORM></BODY></HTML>");
     380: 
>>>  381:         return builder.toString();
     382:     }
     383: 
     384: 
     385:     public String base64Encoded(Document document) throws ConfigurationException, ProcessingException, IOException  {
     386:         String documentAsString = DocumentUtil.getDocumentAsString(document);
```

### Data Flow Step 63: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 381, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
     377:                 .append("</NOSCRIPT>")
     378: 
     379:                 .append("</FORM></BODY></HTML>");
     380: 
>>>  381:         return builder.toString();
     382:     }
     383: 
     384: 
     385:     public String base64Encoded(Document document) throws ConfigurationException, ProcessingException, IOException  {
     386:         String documentAsString = DocumentUtil.getDocumentAsString(document);
```

### Data Flow Step 64: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 353, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
     350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
>>>  353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
     356:     public String buildHtmlForm(String actionUrl, Map<String, String> inputTypes) {
     357:         StringBuilder builder = new StringBuilder();
     358: 
```

### Data Flow Step 65: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 331, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     326: 
     327:         parentNode.replaceChild(clonedAssertionElement, originalAssertionElement);
     328:     }
     329: 
     330:     public String buildHtmlPostResponse(Document responseDoc, String actionUrl, boolean asRequest) throws ProcessingException, ConfigurationException, IOException {
>>>  331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
     332:     }
     333: 
     334:     public static String getSAMLResponse(Document responseDoc) throws ProcessingException, ConfigurationException, IOException {
     335:         byte[] responseBytes = org.keycloak.saml.common.util.DocumentUtil.getDocumentAsString(responseDoc).getBytes(GeneralConstants.SAML_CHARSET);
     336:         return PostBindingUtil.base64Encode(new String(responseBytes, GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 66: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     163:         }
     164:         public Document getDocument() {
     165:             return document;
     166:         }
     167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
     169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
     173:             return str;
```

### Data Flow Step 67: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 169, Column 20
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     164:         public Document getDocument() {
     165:             return document;
     166:         }
     167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
>>>  169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
     173:             return str;
     174:         }
```

### Data Flow Step 68: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      40: 
      41:     public static void sendSaml(boolean asRequest, HttpFacade httpFacade, String actionUrl,
      42:                             BaseSAML2BindingBuilder binding, Document document,
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
      50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 69: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 50, Column 62
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
>>>   50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
      51:             httpFacade.getResponse().end();
      52:         } else {
      53:             String uri = asRequest ? binding.redirectBinding(document).requestURI(actionUrl).toString() : binding.redirectBinding(document).responseURI(actionUrl).toString();
      54:             httpFacade.getResponse().setStatus(302);
      55:             httpFacade.getResponse().setHeader("Location", uri);
```

### Data Flow Step 70: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 50, Column 62
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
>>>   50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
      51:             httpFacade.getResponse().end();
      52:         } else {
      53:             String uri = asRequest ? binding.redirectBinding(document).requestURI(actionUrl).toString() : binding.redirectBinding(document).responseURI(actionUrl).toString();
      54:             httpFacade.getResponse().setStatus(302);
      55:             httpFacade.getResponse().setHeader("Location", uri);
```

## Code Flow 3

### Thread Flow 1

### Data Flow Step 1: adapters/spi/servlet-adapter-spi/src/main/java/org/keycloak/adapters/servlet/ServletHttpFacade.java, Line 93, Column 20
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/spi/servlet-adapter-spi/src/main/java/org/keycloak/adapters/servlet/ServletHttpFacade.java
```java
      88:             return request.isSecure();
      89:         }
      90: 
      91:         @Override
      92:         public String getFirstParam(String param) {
>>>   93:             return request.getParameter(param);
      94:         }
      95: 
      96:         @Override
      97:         public String getQueryParamValue(String param) {
      98:             if (queryParameters == null) {
```

### Data Flow Step 2: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java, Line 40, Column 29
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java
```java
      35: 
      36:     @Override
      37:     public AuthOutcome handle(OnSessionCreated onCreateSession) {
      38:         String samlRequest = facade.getRequest().getFirstParam(GeneralConstants.SAML_REQUEST_KEY);
      39:         String samlResponse = facade.getRequest().getFirstParam(GeneralConstants.SAML_RESPONSE_KEY);
>>>   40:         String relayState = facade.getRequest().getFirstParam(GeneralConstants.RELAY_STATE);
      41:         if (samlRequest != null) {
      42:             return handleSamlRequest(samlRequest, relayState);
      43:         } else if (samlResponse != null) {
      44:             return handleSamlResponse(samlResponse, relayState, onCreateSession);
      45:         }
```

### Data Flow Step 3: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java, Line 42, Column 51
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java
```java
      37:     public AuthOutcome handle(OnSessionCreated onCreateSession) {
      38:         String samlRequest = facade.getRequest().getFirstParam(GeneralConstants.SAML_REQUEST_KEY);
      39:         String samlResponse = facade.getRequest().getFirstParam(GeneralConstants.SAML_RESPONSE_KEY);
      40:         String relayState = facade.getRequest().getFirstParam(GeneralConstants.RELAY_STATE);
      41:         if (samlRequest != null) {
>>>   42:             return handleSamlRequest(samlRequest, relayState);
      43:         } else if (samlResponse != null) {
      44:             return handleSamlResponse(samlResponse, relayState, onCreateSession);
      45:         }
      46:         return AuthOutcome.NOT_ATTEMPTED;
      47: 
```

### Data Flow Step 4: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 163, Column 65
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
     158:     @Override
     159:     public AuthChallenge getChallenge() {
     160:         return this.challenge;
     161:     }
     162: 
>>>  163:     protected AuthOutcome handleSamlRequest(String samlRequest, String relayState) {
     164:         SAMLDocumentHolder holder = null;
     165:         boolean postBinding = false;
     166:         String requestUri = facade.getRequest().getURI();
     167:         if (facade.getRequest().getMethod().equalsIgnoreCase("GET")) {
     168:             // strip out query params
```

### Data Flow Step 5: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 202, Column 42
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
     197:                     log.error("Failed to verify saml request signature", e);
     198:                     return failedTerminal();
     199:                 }
     200:             }
     201:             LogoutRequestType logout = (LogoutRequestType) requestAbstractType;
>>>  202:             return logoutRequest(logout, relayState);
     203: 
     204:         } else {
     205:             log.error("unknown SAML request type");
     206:             return failedTerminal();
     207:         }
```

### Data Flow Step 6: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 68, Column 68
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
      63: 
      64:         return AuthOutcome.AUTHENTICATED;
      65:     }
      66: 
      67:     @Override
>>>   68:     protected AuthOutcome logoutRequest(LogoutRequestType request, String relayState) {
      69:         if (request.getSessionIndex() == null || request.getSessionIndex().isEmpty()) {
      70:             sessionStore.logoutByPrincipal(request.getNameID().getValue());
      71:         } else {
      72:             sessionStore.logoutBySsoId(request.getSessionIndex());
      73:         }
```

### Data Flow Step 7: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 80, Column 84
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
      75:         String issuerURL = deployment.getEntityID();
      76:         SAML2LogoutResponseBuilder builder = new SAML2LogoutResponseBuilder();
      77:         builder.logoutRequestID(request.getID());
      78:         builder.destination(deployment.getIDP().getSingleLogoutService().getResponseBindingUrl());
      79:         builder.issuer(issuerURL);
>>>   80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
      81:         if (deployment.getIDP().getSingleLogoutService().signResponse()) {
      82:             if (deployment.getSignatureCanonicalizationMethod() != null)
      83:                 binding.canonicalizationMethod(deployment.getSignatureCanonicalizationMethod());
      84:             binding.signatureAlgorithm(deployment.getSignatureAlgorithm())
      85:                     .signWith(null, deployment.getSigningKeyPair())
```

### Data Flow Step 8: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 139, Column 25
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     134:     public T encryptionKeySize(int size) {
     135:         this.encryptionKeySize = size;
     136:         return (T)this;
     137:     }
     138: 
>>>  139:     public T relayState(String relayState) {
     140:         this.relayState = relayState;
     141:         return (T)this;
     142:     }
     143: 
     144:     public class BasePostBindingBuilder {
```

### Data Flow Step 9: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 140, Column 27
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     135:         this.encryptionKeySize = size;
     136:         return (T)this;
     137:     }
     138: 
     139:     public T relayState(String relayState) {
>>>  140:         this.relayState = relayState;
     141:         return (T)this;
     142:     }
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
```

### Data Flow Step 10: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 140, Column 9
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     135:         this.encryptionKeySize = size;
     136:         return (T)this;
     137:     }
     138: 
     139:     public T relayState(String relayState) {
>>>  140:         this.relayState = relayState;
     141:         return (T)this;
     142:     }
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
```

### Data Flow Step 11: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 141, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     136:         return (T)this;
     137:     }
     138: 
     139:     public T relayState(String relayState) {
     140:         this.relayState = relayState;
>>>  141:         return (T)this;
     142:     }
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
```

### Data Flow Step 12: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 80, Column 43
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
      75:         String issuerURL = deployment.getEntityID();
      76:         SAML2LogoutResponseBuilder builder = new SAML2LogoutResponseBuilder();
      77:         builder.logoutRequestID(request.getID());
      78:         builder.destination(deployment.getIDP().getSingleLogoutService().getResponseBindingUrl());
      79:         builder.issuer(issuerURL);
>>>   80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
      81:         if (deployment.getIDP().getSingleLogoutService().signResponse()) {
      82:             if (deployment.getSignatureCanonicalizationMethod() != null)
      83:                 binding.canonicalizationMethod(deployment.getSignatureCanonicalizationMethod());
      84:             binding.signatureAlgorithm(deployment.getSignatureAlgorithm())
      85:                     .signWith(null, deployment.getSigningKeyPair())
```

### Data Flow Step 13: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 93, Column 116
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
      88:             //   <related DocumentBuilder>.addExtension(new KeycloakKeySamlExtensionGenerator(<key ID>));
      89:         }
      90: 
      91: 
      92:         try {
>>>   93:             SamlUtil.sendSaml(false, facade, deployment.getIDP().getSingleLogoutService().getResponseBindingUrl(), binding, builder.buildDocument(),
      94:                     deployment.getIDP().getSingleLogoutService().getResponseBinding());
      95:         } catch (Exception e) {
      96:             log.error("Could not send logout response SAML request", e);
      97:             return AuthOutcome.FAILED;
      98:         }
```

### Data Flow Step 14: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 42, Column 29
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      37: public class SamlUtil {
      38: 
      39:     protected static Logger log = Logger.getLogger(SamlUtil.class);
      40: 
      41:     public static void sendSaml(boolean asRequest, HttpFacade httpFacade, String actionUrl,
>>>   42:                             BaseSAML2BindingBuilder binding, Document document,
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
      45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
```

### Data Flow Step 15: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      40: 
      41:     public static void sendSaml(boolean asRequest, HttpFacade httpFacade, String actionUrl,
      42:                             BaseSAML2BindingBuilder binding, Document document,
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
      50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 16: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 242, Column 35
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     237:     public BaseRedirectBindingBuilder redirectBinding(Document document) throws ProcessingException {
     238:         return new BaseRedirectBindingBuilder(this, document);
     239: 
     240:     }
     241: 
>>>  242:     public BasePostBindingBuilder postBinding(Document document) throws ProcessingException {
     243:         return new BasePostBindingBuilder(this, document);
     244: 
     245:     }
     246: 
     247:     public BaseSoapBindingBuilder soapBinding(Document document) throws ProcessingException {
```

### Data Flow Step 17: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 243, Column 43
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     238:         return new BaseRedirectBindingBuilder(this, document);
     239: 
     240:     }
     241: 
     242:     public BasePostBindingBuilder postBinding(Document document) throws ProcessingException {
>>>  243:         return new BasePostBindingBuilder(this, document);
     244: 
     245:     }
     246: 
     247:     public BaseSoapBindingBuilder soapBinding(Document document) throws ProcessingException {
     248:         return new BaseSoapBindingBuilder(this, document);
```

### Data Flow Step 18: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 148, Column 39
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
     147: 
>>>  148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
     149:             this.builder = builder;
     150:             this.document = document;
     151:             if (builder.signAssertions) {
     152:                 builder.signAssertion(document);
     153:             }
```

### Data Flow Step 19: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 149, Column 28
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
     147: 
     148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
>>>  149:             this.builder = builder;
     150:             this.document = document;
     151:             if (builder.signAssertions) {
     152:                 builder.signAssertion(document);
     153:             }
     154:             if (builder.encrypt) builder.encryptDocument(document);
```

### Data Flow Step 20: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 149, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
     147: 
     148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
>>>  149:             this.builder = builder;
     150:             this.document = document;
     151:             if (builder.signAssertions) {
     152:                 builder.signAssertion(document);
     153:             }
     154:             if (builder.encrypt) builder.encryptDocument(document);
```

### Data Flow Step 21: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 148, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
     147: 
>>>  148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
     149:             this.builder = builder;
     150:             this.document = document;
     151:             if (builder.signAssertions) {
     152:                 builder.signAssertion(document);
     153:             }
```

### Data Flow Step 22: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 243, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     238:         return new BaseRedirectBindingBuilder(this, document);
     239: 
     240:     }
     241: 
     242:     public BasePostBindingBuilder postBinding(Document document) throws ProcessingException {
>>>  243:         return new BasePostBindingBuilder(this, document);
     244: 
     245:     }
     246: 
     247:     public BaseSoapBindingBuilder soapBinding(Document document) throws ProcessingException {
     248:         return new BaseSoapBindingBuilder(this, document);
```

### Data Flow Step 23: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      40: 
      41:     public static void sendSaml(boolean asRequest, HttpFacade httpFacade, String actionUrl,
      42:                             BaseSAML2BindingBuilder binding, Document document,
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
      50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 24: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 167, Column 23
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     162:             return PostBindingUtil.base64Encode(new String(responseBytes, GeneralConstants.SAML_CHARSET));
     163:         }
     164:         public Document getDocument() {
     165:             return document;
     166:         }
>>>  167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
     169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
```

### Data Flow Step 25: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     163:         }
     164:         public Document getDocument() {
     165:             return document;
     166:         }
     167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
     169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
     173:             return str;
```

### Data Flow Step 26: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     163:         }
     164:         public Document getDocument() {
     165:             return document;
     166:         }
     167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
     169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
     173:             return str;
```

### Data Flow Step 27: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 330, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     325:         Element parentNode = (Element) originalAssertionElement.getParentNode();
     326: 
     327:         parentNode.replaceChild(clonedAssertionElement, originalAssertionElement);
     328:     }
     329: 
>>>  330:     public String buildHtmlPostResponse(Document responseDoc, String actionUrl, boolean asRequest) throws ProcessingException, ConfigurationException, IOException {
     331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
     332:     }
     333: 
     334:     public static String getSAMLResponse(Document responseDoc) throws ProcessingException, ConfigurationException, IOException {
     335:         byte[] responseBytes = org.keycloak.saml.common.util.DocumentUtil.getDocumentAsString(responseDoc).getBytes(GeneralConstants.SAML_CHARSET);
```

### Data Flow Step 28: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 331, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     326: 
     327:         parentNode.replaceChild(clonedAssertionElement, originalAssertionElement);
     328:     }
     329: 
     330:     public String buildHtmlPostResponse(Document responseDoc, String actionUrl, boolean asRequest) throws ProcessingException, ConfigurationException, IOException {
>>>  331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
     332:     }
     333: 
     334:     public static String getSAMLResponse(Document responseDoc) throws ProcessingException, ConfigurationException, IOException {
     335:         byte[] responseBytes = org.keycloak.saml.common.util.DocumentUtil.getDocumentAsString(responseDoc).getBytes(GeneralConstants.SAML_CHARSET);
     336:         return PostBindingUtil.base64Encode(new String(responseBytes, GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 29: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 339, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     334:     public static String getSAMLResponse(Document responseDoc) throws ProcessingException, ConfigurationException, IOException {
     335:         byte[] responseBytes = org.keycloak.saml.common.util.DocumentUtil.getDocumentAsString(responseDoc).getBytes(GeneralConstants.SAML_CHARSET);
     336:         return PostBindingUtil.base64Encode(new String(responseBytes, GeneralConstants.SAML_CHARSET));
     337:     }
     338: 
>>>  339:     public String buildHtml(String samlResponse, String actionUrl, boolean asRequest) {
     340: 
     341:         String key = GeneralConstants.SAML_RESPONSE_KEY;
     342: 
     343:         if (asRequest) {
     344:             key = GeneralConstants.SAML_REQUEST_KEY;
```

### Data Flow Step 30: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 58
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     345:         }
     346: 
     347:         Map<String, String> inputTypes = new HashMap<>();
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
```

### Data Flow Step 31: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 58
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     345:         }
     346: 
     347:         Map<String, String> inputTypes = new HashMap<>();
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
```

### Data Flow Step 32: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     345:         }
     346: 
     347:         Map<String, String> inputTypes = new HashMap<>();
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
```

### Data Flow Step 33: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 353, Column 41
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
     350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
>>>  353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
     356:     public String buildHtmlForm(String actionUrl, Map<String, String> inputTypes) {
     357:         StringBuilder builder = new StringBuilder();
     358: 
```

### Data Flow Step 34: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 356, Column 51
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
>>>  356:     public String buildHtmlForm(String actionUrl, Map<String, String> inputTypes) {
     357:         StringBuilder builder = new StringBuilder();
     358: 
     359:         builder.append("<HTML>")
     360:                 .append("<HEAD>")
     361: 
```

### Data Flow Step 35: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 130
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
```

### Data Flow Step 36: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 130
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
```

### Data Flow Step 37: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 30, Column 42
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      25:      * <p>Escapes the value for a HTML element attribute.</p>
      26:      *
      27:      * @param value
      28:      * @return
      29:      */
>>>   30:     public static String escapeAttribute(String value) {
      31:         StringBuilder escaped = new StringBuilder();
      32: 
      33:         for (int i = 0; i < value.length(); i++) {
      34:             char chr = value.charAt(i);
      35: 
```

### Data Flow Step 38: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 34, Column 24
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      29:      */
      30:     public static String escapeAttribute(String value) {
      31:         StringBuilder escaped = new StringBuilder();
      32: 
      33:         for (int i = 0; i < value.length(); i++) {
>>>   34:             char chr = value.charAt(i);
      35: 
      36:             if (chr == '<') {
      37:                 escaped.append("&lt;");
      38:             } else if (chr == '>') {
      39:                 escaped.append("&gt;");
```

### Data Flow Step 39: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 34, Column 24
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      29:      */
      30:     public static String escapeAttribute(String value) {
      31:         StringBuilder escaped = new StringBuilder();
      32: 
      33:         for (int i = 0; i < value.length(); i++) {
>>>   34:             char chr = value.charAt(i);
      35: 
      36:             if (chr == '<') {
      37:                 escaped.append("&lt;");
      38:             } else if (chr == '>') {
      39:                 escaped.append("&gt;");
```

### Data Flow Step 40: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 47, Column 32
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      42:             } else if (chr == '\'') {
      43:                 escaped.append("&apos;");
      44:             } else if (chr == '&') {
      45:                 escaped.append("&amp;");
      46:             } else {
>>>   47:                 escaped.append(chr);
      48:             }
      49:         }
      50: 
      51:         return escaped.toString();
      52:     }
```

### Data Flow Step 41: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 47, Column 17
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      42:             } else if (chr == '\'') {
      43:                 escaped.append("&apos;");
      44:             } else if (chr == '&') {
      45:                 escaped.append("&amp;");
      46:             } else {
>>>   47:                 escaped.append(chr);
      48:             }
      49:         }
      50: 
      51:         return escaped.toString();
      52:     }
```

### Data Flow Step 42: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 51, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      46:             } else {
      47:                 escaped.append(chr);
      48:             }
      49:         }
      50: 
>>>   51:         return escaped.toString();
      52:     }
      53: 
      54: }
```

### Data Flow Step 43: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 51, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      46:             } else {
      47:                 escaped.append(chr);
      48:             }
      49:         }
      50: 
>>>   51:         return escaped.toString();
      52:     }
      53: 
      54: }
```

### Data Flow Step 44: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 114
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
```

### Data Flow Step 45: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
```

### Data Flow Step 46: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 381, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
     377:                 .append("</NOSCRIPT>")
     378: 
     379:                 .append("</FORM></BODY></HTML>");
     380: 
>>>  381:         return builder.toString();
     382:     }
     383: 
     384: 
     385:     public String base64Encoded(Document document) throws ConfigurationException, ProcessingException, IOException  {
     386:         String documentAsString = DocumentUtil.getDocumentAsString(document);
```

### Data Flow Step 47: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 381, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
     377:                 .append("</NOSCRIPT>")
     378: 
     379:                 .append("</FORM></BODY></HTML>");
     380: 
>>>  381:         return builder.toString();
     382:     }
     383: 
     384: 
     385:     public String base64Encoded(Document document) throws ConfigurationException, ProcessingException, IOException  {
     386:         String documentAsString = DocumentUtil.getDocumentAsString(document);
```

### Data Flow Step 48: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 353, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
     350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
>>>  353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
     356:     public String buildHtmlForm(String actionUrl, Map<String, String> inputTypes) {
     357:         StringBuilder builder = new StringBuilder();
     358: 
```

### Data Flow Step 49: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 331, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     326: 
     327:         parentNode.replaceChild(clonedAssertionElement, originalAssertionElement);
     328:     }
     329: 
     330:     public String buildHtmlPostResponse(Document responseDoc, String actionUrl, boolean asRequest) throws ProcessingException, ConfigurationException, IOException {
>>>  331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
     332:     }
     333: 
     334:     public static String getSAMLResponse(Document responseDoc) throws ProcessingException, ConfigurationException, IOException {
     335:         byte[] responseBytes = org.keycloak.saml.common.util.DocumentUtil.getDocumentAsString(responseDoc).getBytes(GeneralConstants.SAML_CHARSET);
     336:         return PostBindingUtil.base64Encode(new String(responseBytes, GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 50: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     163:         }
     164:         public Document getDocument() {
     165:             return document;
     166:         }
     167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
     169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
     173:             return str;
```

### Data Flow Step 51: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 169, Column 20
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     164:         public Document getDocument() {
     165:             return document;
     166:         }
     167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
>>>  169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
     173:             return str;
     174:         }
```

### Data Flow Step 52: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      40: 
      41:     public static void sendSaml(boolean asRequest, HttpFacade httpFacade, String actionUrl,
      42:                             BaseSAML2BindingBuilder binding, Document document,
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
      50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 53: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 50, Column 62
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
>>>   50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
      51:             httpFacade.getResponse().end();
      52:         } else {
      53:             String uri = asRequest ? binding.redirectBinding(document).requestURI(actionUrl).toString() : binding.redirectBinding(document).responseURI(actionUrl).toString();
      54:             httpFacade.getResponse().setStatus(302);
      55:             httpFacade.getResponse().setHeader("Location", uri);
```

### Data Flow Step 54: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 50, Column 62
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
>>>   50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
      51:             httpFacade.getResponse().end();
      52:         } else {
      53:             String uri = asRequest ? binding.redirectBinding(document).requestURI(actionUrl).toString() : binding.redirectBinding(document).responseURI(actionUrl).toString();
      54:             httpFacade.getResponse().setStatus(302);
      55:             httpFacade.getResponse().setHeader("Location", uri);
```

## Code Flow 4

### Thread Flow 1

### Data Flow Step 1: adapters/spi/undertow-adapter-spi/src/main/java/org/keycloak/adapters/undertow/ServletHttpFacade.java, Line 46, Column 20
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/spi/undertow-adapter-spi/src/main/java/org/keycloak/adapters/undertow/ServletHttpFacade.java
```java
      41:     }
      42: 
      43:     protected class RequestFacade extends UndertowHttpFacade.RequestFacade {
      44:         @Override
      45:         public String getFirstParam(String param) {
>>>   46:             return request.getParameter(param);
      47:         }
      48: 
      49:         @Override
      50:         public void setError(AuthenticationError error) {
      51:             request.setAttribute(AuthenticationError.class.getName(), error);
```

### Data Flow Step 2: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java, Line 40, Column 29
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java
```java
      35: 
      36:     @Override
      37:     public AuthOutcome handle(OnSessionCreated onCreateSession) {
      38:         String samlRequest = facade.getRequest().getFirstParam(GeneralConstants.SAML_REQUEST_KEY);
      39:         String samlResponse = facade.getRequest().getFirstParam(GeneralConstants.SAML_RESPONSE_KEY);
>>>   40:         String relayState = facade.getRequest().getFirstParam(GeneralConstants.RELAY_STATE);
      41:         if (samlRequest != null) {
      42:             return handleSamlRequest(samlRequest, relayState);
      43:         } else if (samlResponse != null) {
      44:             return handleSamlResponse(samlResponse, relayState, onCreateSession);
      45:         }
```

### Data Flow Step 3: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java, Line 42, Column 51
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/SamlEndpoint.java
```java
      37:     public AuthOutcome handle(OnSessionCreated onCreateSession) {
      38:         String samlRequest = facade.getRequest().getFirstParam(GeneralConstants.SAML_REQUEST_KEY);
      39:         String samlResponse = facade.getRequest().getFirstParam(GeneralConstants.SAML_RESPONSE_KEY);
      40:         String relayState = facade.getRequest().getFirstParam(GeneralConstants.RELAY_STATE);
      41:         if (samlRequest != null) {
>>>   42:             return handleSamlRequest(samlRequest, relayState);
      43:         } else if (samlResponse != null) {
      44:             return handleSamlResponse(samlResponse, relayState, onCreateSession);
      45:         }
      46:         return AuthOutcome.NOT_ATTEMPTED;
      47: 
```

### Data Flow Step 4: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 163, Column 65
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
     158:     @Override
     159:     public AuthChallenge getChallenge() {
     160:         return this.challenge;
     161:     }
     162: 
>>>  163:     protected AuthOutcome handleSamlRequest(String samlRequest, String relayState) {
     164:         SAMLDocumentHolder holder = null;
     165:         boolean postBinding = false;
     166:         String requestUri = facade.getRequest().getURI();
     167:         if (facade.getRequest().getMethod().equalsIgnoreCase("GET")) {
     168:             // strip out query params
```

### Data Flow Step 5: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java, Line 202, Column 42
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/AbstractSamlAuthenticationHandler.java
```java
     197:                     log.error("Failed to verify saml request signature", e);
     198:                     return failedTerminal();
     199:                 }
     200:             }
     201:             LogoutRequestType logout = (LogoutRequestType) requestAbstractType;
>>>  202:             return logoutRequest(logout, relayState);
     203: 
     204:         } else {
     205:             log.error("unknown SAML request type");
     206:             return failedTerminal();
     207:         }
```

### Data Flow Step 6: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 68, Column 68
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
      63: 
      64:         return AuthOutcome.AUTHENTICATED;
      65:     }
      66: 
      67:     @Override
>>>   68:     protected AuthOutcome logoutRequest(LogoutRequestType request, String relayState) {
      69:         if (request.getSessionIndex() == null || request.getSessionIndex().isEmpty()) {
      70:             sessionStore.logoutByPrincipal(request.getNameID().getValue());
      71:         } else {
      72:             sessionStore.logoutBySsoId(request.getSessionIndex());
      73:         }
```

### Data Flow Step 7: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 80, Column 84
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
      75:         String issuerURL = deployment.getEntityID();
      76:         SAML2LogoutResponseBuilder builder = new SAML2LogoutResponseBuilder();
      77:         builder.logoutRequestID(request.getID());
      78:         builder.destination(deployment.getIDP().getSingleLogoutService().getResponseBindingUrl());
      79:         builder.issuer(issuerURL);
>>>   80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
      81:         if (deployment.getIDP().getSingleLogoutService().signResponse()) {
      82:             if (deployment.getSignatureCanonicalizationMethod() != null)
      83:                 binding.canonicalizationMethod(deployment.getSignatureCanonicalizationMethod());
      84:             binding.signatureAlgorithm(deployment.getSignatureAlgorithm())
      85:                     .signWith(null, deployment.getSigningKeyPair())
```

### Data Flow Step 8: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 139, Column 25
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     134:     public T encryptionKeySize(int size) {
     135:         this.encryptionKeySize = size;
     136:         return (T)this;
     137:     }
     138: 
>>>  139:     public T relayState(String relayState) {
     140:         this.relayState = relayState;
     141:         return (T)this;
     142:     }
     143: 
     144:     public class BasePostBindingBuilder {
```

### Data Flow Step 9: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 140, Column 27
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     135:         this.encryptionKeySize = size;
     136:         return (T)this;
     137:     }
     138: 
     139:     public T relayState(String relayState) {
>>>  140:         this.relayState = relayState;
     141:         return (T)this;
     142:     }
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
```

### Data Flow Step 10: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 140, Column 9
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     135:         this.encryptionKeySize = size;
     136:         return (T)this;
     137:     }
     138: 
     139:     public T relayState(String relayState) {
>>>  140:         this.relayState = relayState;
     141:         return (T)this;
     142:     }
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
```

### Data Flow Step 11: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 141, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     136:         return (T)this;
     137:     }
     138: 
     139:     public T relayState(String relayState) {
     140:         this.relayState = relayState;
>>>  141:         return (T)this;
     142:     }
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
```

### Data Flow Step 12: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 80, Column 43
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
      75:         String issuerURL = deployment.getEntityID();
      76:         SAML2LogoutResponseBuilder builder = new SAML2LogoutResponseBuilder();
      77:         builder.logoutRequestID(request.getID());
      78:         builder.destination(deployment.getIDP().getSingleLogoutService().getResponseBindingUrl());
      79:         builder.issuer(issuerURL);
>>>   80:         BaseSAML2BindingBuilder binding = new BaseSAML2BindingBuilder().relayState(relayState);
      81:         if (deployment.getIDP().getSingleLogoutService().signResponse()) {
      82:             if (deployment.getSignatureCanonicalizationMethod() != null)
      83:                 binding.canonicalizationMethod(deployment.getSignatureCanonicalizationMethod());
      84:             binding.signatureAlgorithm(deployment.getSignatureAlgorithm())
      85:                     .signWith(null, deployment.getSigningKeyPair())
```

### Data Flow Step 13: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java, Line 93, Column 116
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/profile/webbrowsersso/WebBrowserSsoAuthenticationHandler.java
```java
      88:             //   <related DocumentBuilder>.addExtension(new KeycloakKeySamlExtensionGenerator(<key ID>));
      89:         }
      90: 
      91: 
      92:         try {
>>>   93:             SamlUtil.sendSaml(false, facade, deployment.getIDP().getSingleLogoutService().getResponseBindingUrl(), binding, builder.buildDocument(),
      94:                     deployment.getIDP().getSingleLogoutService().getResponseBinding());
      95:         } catch (Exception e) {
      96:             log.error("Could not send logout response SAML request", e);
      97:             return AuthOutcome.FAILED;
      98:         }
```

### Data Flow Step 14: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 42, Column 29
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      37: public class SamlUtil {
      38: 
      39:     protected static Logger log = Logger.getLogger(SamlUtil.class);
      40: 
      41:     public static void sendSaml(boolean asRequest, HttpFacade httpFacade, String actionUrl,
>>>   42:                             BaseSAML2BindingBuilder binding, Document document,
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
      45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
```

### Data Flow Step 15: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      40: 
      41:     public static void sendSaml(boolean asRequest, HttpFacade httpFacade, String actionUrl,
      42:                             BaseSAML2BindingBuilder binding, Document document,
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
      50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 16: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 242, Column 35
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     237:     public BaseRedirectBindingBuilder redirectBinding(Document document) throws ProcessingException {
     238:         return new BaseRedirectBindingBuilder(this, document);
     239: 
     240:     }
     241: 
>>>  242:     public BasePostBindingBuilder postBinding(Document document) throws ProcessingException {
     243:         return new BasePostBindingBuilder(this, document);
     244: 
     245:     }
     246: 
     247:     public BaseSoapBindingBuilder soapBinding(Document document) throws ProcessingException {
```

### Data Flow Step 17: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 243, Column 43
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     238:         return new BaseRedirectBindingBuilder(this, document);
     239: 
     240:     }
     241: 
     242:     public BasePostBindingBuilder postBinding(Document document) throws ProcessingException {
>>>  243:         return new BasePostBindingBuilder(this, document);
     244: 
     245:     }
     246: 
     247:     public BaseSoapBindingBuilder soapBinding(Document document) throws ProcessingException {
     248:         return new BaseSoapBindingBuilder(this, document);
```

### Data Flow Step 18: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 148, Column 39
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
     147: 
>>>  148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
     149:             this.builder = builder;
     150:             this.document = document;
     151:             if (builder.signAssertions) {
     152:                 builder.signAssertion(document);
     153:             }
```

### Data Flow Step 19: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 149, Column 28
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
     147: 
     148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
>>>  149:             this.builder = builder;
     150:             this.document = document;
     151:             if (builder.signAssertions) {
     152:                 builder.signAssertion(document);
     153:             }
     154:             if (builder.encrypt) builder.encryptDocument(document);
```

### Data Flow Step 20: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 149, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
     147: 
     148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
>>>  149:             this.builder = builder;
     150:             this.document = document;
     151:             if (builder.signAssertions) {
     152:                 builder.signAssertion(document);
     153:             }
     154:             if (builder.encrypt) builder.encryptDocument(document);
```

### Data Flow Step 21: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 148, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     143: 
     144:     public class BasePostBindingBuilder {
     145:         protected Document document;
     146:         protected BaseSAML2BindingBuilder builder;
     147: 
>>>  148:         public BasePostBindingBuilder(BaseSAML2BindingBuilder builder, Document document) throws ProcessingException {
     149:             this.builder = builder;
     150:             this.document = document;
     151:             if (builder.signAssertions) {
     152:                 builder.signAssertion(document);
     153:             }
```

### Data Flow Step 22: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 243, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     238:         return new BaseRedirectBindingBuilder(this, document);
     239: 
     240:     }
     241: 
     242:     public BasePostBindingBuilder postBinding(Document document) throws ProcessingException {
>>>  243:         return new BasePostBindingBuilder(this, document);
     244: 
     245:     }
     246: 
     247:     public BaseSoapBindingBuilder soapBinding(Document document) throws ProcessingException {
     248:         return new BaseSoapBindingBuilder(this, document);
```

### Data Flow Step 23: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      40: 
      41:     public static void sendSaml(boolean asRequest, HttpFacade httpFacade, String actionUrl,
      42:                             BaseSAML2BindingBuilder binding, Document document,
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
      50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 24: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 167, Column 23
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     162:             return PostBindingUtil.base64Encode(new String(responseBytes, GeneralConstants.SAML_CHARSET));
     163:         }
     164:         public Document getDocument() {
     165:             return document;
     166:         }
>>>  167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
     169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
```

### Data Flow Step 25: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     163:         }
     164:         public Document getDocument() {
     165:             return document;
     166:         }
     167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
     169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
     173:             return str;
```

### Data Flow Step 26: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     163:         }
     164:         public Document getDocument() {
     165:             return document;
     166:         }
     167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
     169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
     173:             return str;
```

### Data Flow Step 27: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 330, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     325:         Element parentNode = (Element) originalAssertionElement.getParentNode();
     326: 
     327:         parentNode.replaceChild(clonedAssertionElement, originalAssertionElement);
     328:     }
     329: 
>>>  330:     public String buildHtmlPostResponse(Document responseDoc, String actionUrl, boolean asRequest) throws ProcessingException, ConfigurationException, IOException {
     331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
     332:     }
     333: 
     334:     public static String getSAMLResponse(Document responseDoc) throws ProcessingException, ConfigurationException, IOException {
     335:         byte[] responseBytes = org.keycloak.saml.common.util.DocumentUtil.getDocumentAsString(responseDoc).getBytes(GeneralConstants.SAML_CHARSET);
```

### Data Flow Step 28: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 331, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     326: 
     327:         parentNode.replaceChild(clonedAssertionElement, originalAssertionElement);
     328:     }
     329: 
     330:     public String buildHtmlPostResponse(Document responseDoc, String actionUrl, boolean asRequest) throws ProcessingException, ConfigurationException, IOException {
>>>  331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
     332:     }
     333: 
     334:     public static String getSAMLResponse(Document responseDoc) throws ProcessingException, ConfigurationException, IOException {
     335:         byte[] responseBytes = org.keycloak.saml.common.util.DocumentUtil.getDocumentAsString(responseDoc).getBytes(GeneralConstants.SAML_CHARSET);
     336:         return PostBindingUtil.base64Encode(new String(responseBytes, GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 29: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 339, Column 19
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     334:     public static String getSAMLResponse(Document responseDoc) throws ProcessingException, ConfigurationException, IOException {
     335:         byte[] responseBytes = org.keycloak.saml.common.util.DocumentUtil.getDocumentAsString(responseDoc).getBytes(GeneralConstants.SAML_CHARSET);
     336:         return PostBindingUtil.base64Encode(new String(responseBytes, GeneralConstants.SAML_CHARSET));
     337:     }
     338: 
>>>  339:     public String buildHtml(String samlResponse, String actionUrl, boolean asRequest) {
     340: 
     341:         String key = GeneralConstants.SAML_RESPONSE_KEY;
     342: 
     343:         if (asRequest) {
     344:             key = GeneralConstants.SAML_REQUEST_KEY;
```

### Data Flow Step 30: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 58
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     345:         }
     346: 
     347:         Map<String, String> inputTypes = new HashMap<>();
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
```

### Data Flow Step 31: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 58
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     345:         }
     346: 
     347:         Map<String, String> inputTypes = new HashMap<>();
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
```

### Data Flow Step 32: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 350, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     345:         }
     346: 
     347:         Map<String, String> inputTypes = new HashMap<>();
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
>>>  350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
```

### Data Flow Step 33: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 353, Column 41
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
     350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
>>>  353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
     356:     public String buildHtmlForm(String actionUrl, Map<String, String> inputTypes) {
     357:         StringBuilder builder = new StringBuilder();
     358: 
```

### Data Flow Step 34: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 356, Column 51
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     351:         }
     352: 
     353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
>>>  356:     public String buildHtmlForm(String actionUrl, Map<String, String> inputTypes) {
     357:         StringBuilder builder = new StringBuilder();
     358: 
     359:         builder.append("<HTML>")
     360:                 .append("<HEAD>")
     361: 
```

### Data Flow Step 35: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 130
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
```

### Data Flow Step 36: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 130
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
```

### Data Flow Step 37: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 30, Column 42
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      25:      * <p>Escapes the value for a HTML element attribute.</p>
      26:      *
      27:      * @param value
      28:      * @return
      29:      */
>>>   30:     public static String escapeAttribute(String value) {
      31:         StringBuilder escaped = new StringBuilder();
      32: 
      33:         for (int i = 0; i < value.length(); i++) {
      34:             char chr = value.charAt(i);
      35: 
```

### Data Flow Step 38: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 34, Column 24
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      29:      */
      30:     public static String escapeAttribute(String value) {
      31:         StringBuilder escaped = new StringBuilder();
      32: 
      33:         for (int i = 0; i < value.length(); i++) {
>>>   34:             char chr = value.charAt(i);
      35: 
      36:             if (chr == '<') {
      37:                 escaped.append("&lt;");
      38:             } else if (chr == '>') {
      39:                 escaped.append("&gt;");
```

### Data Flow Step 39: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 34, Column 24
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      29:      */
      30:     public static String escapeAttribute(String value) {
      31:         StringBuilder escaped = new StringBuilder();
      32: 
      33:         for (int i = 0; i < value.length(); i++) {
>>>   34:             char chr = value.charAt(i);
      35: 
      36:             if (chr == '<') {
      37:                 escaped.append("&lt;");
      38:             } else if (chr == '>') {
      39:                 escaped.append("&gt;");
```

### Data Flow Step 40: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 47, Column 32
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      42:             } else if (chr == '\'') {
      43:                 escaped.append("&apos;");
      44:             } else if (chr == '&') {
      45:                 escaped.append("&amp;");
      46:             } else {
>>>   47:                 escaped.append(chr);
      48:             }
      49:         }
      50: 
      51:         return escaped.toString();
      52:     }
```

### Data Flow Step 41: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 47, Column 17
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      42:             } else if (chr == '\'') {
      43:                 escaped.append("&apos;");
      44:             } else if (chr == '&') {
      45:                 escaped.append("&amp;");
      46:             } else {
>>>   47:                 escaped.append(chr);
      48:             }
      49:         }
      50: 
      51:         return escaped.toString();
      52:     }
```

### Data Flow Step 42: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 51, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      46:             } else {
      47:                 escaped.append(chr);
      48:             }
      49:         }
      50: 
>>>   51:         return escaped.toString();
      52:     }
      53: 
      54: }
```

### Data Flow Step 43: common/src/main/java/org/keycloak/common/util/HtmlUtils.java, Line 51, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/common/src/main/java/org/keycloak/common/util/HtmlUtils.java
```java
      46:             } else {
      47:                 escaped.append(chr);
      48:             }
      49:         }
      50: 
>>>   51:         return escaped.toString();
      52:     }
      53: 
      54: }
```

### Data Flow Step 44: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 114
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
```

### Data Flow Step 45: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 371, Column 13
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     366:                 .append("<FORM METHOD=\"POST\" ACTION=\"").append(actionUrl).append("\">");
     367: 
     368:         builder.append("<p>Redirecting, please wait.</p>");
     369: 
     370:         for (String key: inputTypes.keySet()) {
>>>  371:             builder.append("<INPUT TYPE=\"HIDDEN\" NAME=\"").append(key).append("\"").append(" VALUE=\"").append(escapeAttribute(inputTypes.get(key))).append("\"/>");
     372:         }
     373: 
     374:         builder.append("<NOSCRIPT>")
     375:                 .append("<P>JavaScript is disabled. We strongly recommend to enable it. Click the button below to continue.</P>")
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
```

### Data Flow Step 46: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 381, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
     377:                 .append("</NOSCRIPT>")
     378: 
     379:                 .append("</FORM></BODY></HTML>");
     380: 
>>>  381:         return builder.toString();
     382:     }
     383: 
     384: 
     385:     public String base64Encoded(Document document) throws ConfigurationException, ProcessingException, IOException  {
     386:         String documentAsString = DocumentUtil.getDocumentAsString(document);
```

### Data Flow Step 47: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 381, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     376:                 .append("<INPUT TYPE=\"SUBMIT\" VALUE=\"CONTINUE\" />")
     377:                 .append("</NOSCRIPT>")
     378: 
     379:                 .append("</FORM></BODY></HTML>");
     380: 
>>>  381:         return builder.toString();
     382:     }
     383: 
     384: 
     385:     public String base64Encoded(Document document) throws ConfigurationException, ProcessingException, IOException  {
     386:         String documentAsString = DocumentUtil.getDocumentAsString(document);
```

### Data Flow Step 48: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 353, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     348:         inputTypes.put(key, samlResponse);
     349:         if (isNotNull(relayState)) {
     350:             inputTypes.put(GeneralConstants.RELAY_STATE, relayState);
     351:         }
     352: 
>>>  353:         return buildHtmlForm(actionUrl, inputTypes);
     354:     }
     355: 
     356:     public String buildHtmlForm(String actionUrl, Map<String, String> inputTypes) {
     357:         StringBuilder builder = new StringBuilder();
     358: 
```

### Data Flow Step 49: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 331, Column 16
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     326: 
     327:         parentNode.replaceChild(clonedAssertionElement, originalAssertionElement);
     328:     }
     329: 
     330:     public String buildHtmlPostResponse(Document responseDoc, String actionUrl, boolean asRequest) throws ProcessingException, ConfigurationException, IOException {
>>>  331:         return buildHtml(getSAMLResponse(responseDoc), actionUrl, asRequest);
     332:     }
     333: 
     334:     public static String getSAMLResponse(Document responseDoc) throws ProcessingException, ConfigurationException, IOException {
     335:         byte[] responseBytes = org.keycloak.saml.common.util.DocumentUtil.getDocumentAsString(responseDoc).getBytes(GeneralConstants.SAML_CHARSET);
     336:         return PostBindingUtil.base64Encode(new String(responseBytes, GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 50: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 168, Column 26
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     163:         }
     164:         public Document getDocument() {
     165:             return document;
     166:         }
     167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
>>>  168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
     169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
     173:             return str;
```

### Data Flow Step 51: saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java, Line 169, Column 20
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/saml-core/src/main/java/org/keycloak/saml/BaseSAML2BindingBuilder.java
```java
     164:         public Document getDocument() {
     165:             return document;
     166:         }
     167:         public String getHtmlResponse(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     168:             String str = builder.buildHtmlPostResponse(document, actionUrl, false);
>>>  169:             return str;
     170:         }
     171:         public String getHtmlRequest(String actionUrl) throws ProcessingException, ConfigurationException, IOException {
     172:             String str = builder.buildHtmlPostResponse(document, actionUrl, true);
     173:             return str;
     174:         }
```

### Data Flow Step 52: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 45, Column 97
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      40: 
      41:     public static void sendSaml(boolean asRequest, HttpFacade httpFacade, String actionUrl,
      42:                             BaseSAML2BindingBuilder binding, Document document,
      43:                             SamlDeployment.Binding samlBinding) throws ProcessingException, ConfigurationException, IOException {
      44:         if (samlBinding == SamlDeployment.Binding.POST) {
>>>   45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
      50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
```

### Data Flow Step 53: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 50, Column 62
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
>>>   50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
      51:             httpFacade.getResponse().end();
      52:         } else {
      53:             String uri = asRequest ? binding.redirectBinding(document).requestURI(actionUrl).toString() : binding.redirectBinding(document).responseURI(actionUrl).toString();
      54:             httpFacade.getResponse().setStatus(302);
      55:             httpFacade.getResponse().setHeader("Location", uri);
```

### Data Flow Step 54: adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java, Line 50, Column 62
File: codeql-dbs/keycloak__keycloak_CVE-2022-4361_21.1.1/root/cwe-bench-java/project-sources/keycloak__keycloak_CVE-2022-4361_21.1.1/adapters/saml/core/src/main/java/org/keycloak/adapters/saml/SamlUtil.java
```java
      45:             String html = asRequest ? binding.postBinding(document).getHtmlRequest(actionUrl) : binding.postBinding(document).getHtmlResponse(actionUrl) ;
      46:             httpFacade.getResponse().setStatus(200);
      47:             httpFacade.getResponse().setHeader("Content-Type", "text/html");
      48:             httpFacade.getResponse().setHeader("Pragma", "no-cache");
      49:             httpFacade.getResponse().setHeader("Cache-Control", "no-cache, no-store");
>>>   50:             httpFacade.getResponse().getOutputStream().write(html.getBytes(GeneralConstants.SAML_CHARSET));
      51:             httpFacade.getResponse().end();
      52:         } else {
      53:             String uri = asRequest ? binding.redirectBinding(document).requestURI(actionUrl).toString() : binding.redirectBinding(document).responseURI(actionUrl).toString();
      54:             httpFacade.getResponse().setStatus(302);
      55:             httpFacade.getResponse().setHeader("Location", uri);
```
